

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>color_tools.palette &mdash; Color Tools 5.2.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../../_static/custom.css?v=08153a50" />

  
      <script src="../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../_static/documentation_options.js?v=2dde5210"></script>
      <script src="../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            Color Tools
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../api/color_tools.conversions.html">color_tools.conversions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/color_tools.distance.html">color_tools.distance</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/color_tools.palette.html">color_tools.palette</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/color_tools.gamut.html">color_tools.gamut</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/color_tools.validation.html">color_tools.validation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/color_tools.naming.html">color_tools.naming</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/color_tools.color_deficiency.html">color_tools.color_deficiency</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/color_tools.export.html">color_tools.export</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/color_tools.config.html">color_tools.config</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/color_tools.constants.html">color_tools.constants</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/color_tools.matrices.html">color_tools.matrices</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/color_tools.image.html">color_tools.image</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Color Tools</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">color_tools.palette</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for color_tools.palette</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Color and filament palette management with fast lookup.</span>

<span class="sd">This module provides:</span>
<span class="sd">1. Data classes for colors (ColorRecord) and filaments (FilamentRecord)</span>
<span class="sd">2. Functions to load color/filament data from JSON with user override support</span>
<span class="sd">3. Palette classes with multiple indices for O(1) lookups</span>
<span class="sd">4. Nearest-color search using various distance metrics</span>

<span class="sd">The palette classes are like databases with multiple indexes - you can</span>
<span class="sd">search by name, RGB, HSL, maker, type, etc. and get instant results!</span>

<span class="sd">User files (user/user-colors.json, user/user-filaments.json) always override core</span>
<span class="sd">data when there are conflicts. Override information is logged for transparency.</span>

<span class="sd">Example:</span>
<span class="sd">    &gt;&gt;&gt; from color_tools import Palette, FilamentPalette</span>
<span class="sd">    &gt;&gt;&gt; </span>
<span class="sd">    &gt;&gt;&gt; # Load CSS color database</span>
<span class="sd">    &gt;&gt;&gt; palette = Palette.load_default()</span>
<span class="sd">    &gt;&gt;&gt; print(f&quot;Loaded {len(palette.colors)} CSS colors&quot;)</span>
<span class="sd">    Loaded 148 CSS colors</span>
<span class="sd">    &gt;&gt;&gt; </span>
<span class="sd">    &gt;&gt;&gt; # Find exact color by name</span>
<span class="sd">    &gt;&gt;&gt; coral = palette.get_by_name(&quot;coral&quot;)</span>
<span class="sd">    &gt;&gt;&gt; print(f&quot;Coral: RGB{coral.rgb} (#{coral.hex})&quot;)</span>
<span class="sd">    Coral: RGB(255, 127, 80) (#FF7F50)</span>
<span class="sd">    &gt;&gt;&gt; </span>
<span class="sd">    &gt;&gt;&gt; # Find nearest color to custom RGB</span>
<span class="sd">    &gt;&gt;&gt; custom_orange = (255, 140, 60)</span>
<span class="sd">    &gt;&gt;&gt; nearest, distance = palette.nearest_color(custom_orange)</span>
<span class="sd">    &gt;&gt;&gt; print(f&quot;Nearest to RGB{custom_orange}: {nearest.name} (Î”E: {distance:.1f})&quot;)</span>
<span class="sd">    Nearest to RGB(255, 140, 60): darkorange (Î”E: 7.2)</span>
<span class="sd">    &gt;&gt;&gt; </span>
<span class="sd">    &gt;&gt;&gt; # Load 3D printing filaments </span>
<span class="sd">    &gt;&gt;&gt; filaments = FilamentPalette.load_default()</span>
<span class="sd">    &gt;&gt;&gt; </span>
<span class="sd">    &gt;&gt;&gt; # Search by maker and material</span>
<span class="sd">    &gt;&gt;&gt; pla_colors = filaments.find_by_maker(&quot;Bambu&quot;, type_name=&quot;PLA&quot;)</span>
<span class="sd">    &gt;&gt;&gt; print(f&quot;Found {len(pla_colors)} Bambu PLA colors&quot;)</span>
<span class="sd">    Found 24 Bambu PLA colors</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">__future__</span><span class="w"> </span><span class="kn">import</span> <span class="n">annotations</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">dataclasses</span><span class="w"> </span><span class="kn">import</span> <span class="n">dataclass</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Union</span><span class="p">,</span> <span class="n">Set</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">.constants</span><span class="w"> </span><span class="kn">import</span> <span class="n">ColorConstants</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.conversions</span><span class="w"> </span><span class="kn">import</span> <span class="n">hex_to_rgb</span><span class="p">,</span> <span class="n">rgb_to_lab</span><span class="p">,</span> <span class="n">rgb_to_hsl</span><span class="p">,</span> <span class="n">lab_to_rgb</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.distance</span><span class="w"> </span><span class="kn">import</span> <span class="n">euclidean</span><span class="p">,</span> <span class="n">hsl_euclidean</span><span class="p">,</span> <span class="n">delta_e_2000</span><span class="p">,</span> <span class="n">delta_e_94</span><span class="p">,</span> <span class="n">delta_e_76</span><span class="p">,</span> <span class="n">delta_e_cmc</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.config</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_dual_color_mode</span>

<span class="c1"># Set up logger for override tracking</span>
<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_should_prefer_source</span><span class="p">(</span><span class="n">new_source</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">current_source</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Determine if new_source should be preferred over current_source for ties.</span>
<span class="sd">    </span>
<span class="sd">    User files always win over core files when distances are equal.</span>
<span class="sd">    This ensures consistent behavior between index lookups and distance-based searches.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        new_source: Source filename of the candidate record</span>
<span class="sd">        current_source: Source filename of the current best record</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">        True if new_source should be preferred over current_source</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Core filenames (these are overridden by user files)</span>
    <span class="n">core_files</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;colors.json&quot;</span><span class="p">,</span> <span class="s2">&quot;filaments.json&quot;</span><span class="p">}</span>
    
    <span class="n">new_is_core</span> <span class="o">=</span> <span class="n">new_source</span> <span class="ow">in</span> <span class="n">core_files</span>
    <span class="n">current_is_core</span> <span class="o">=</span> <span class="n">current_source</span> <span class="ow">in</span> <span class="n">core_files</span>
    
    <span class="c1"># If current is core and new is user, prefer new (user override)</span>
    <span class="k">if</span> <span class="n">current_is_core</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">new_is_core</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">True</span>
    
    <span class="c1"># If current is user and new is core, keep current (user wins)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">current_is_core</span> <span class="ow">and</span> <span class="n">new_is_core</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>
    
    <span class="c1"># Both are same type (core or user), don&#39;t prefer either</span>
    <span class="k">return</span> <span class="kc">False</span>


<span class="c1"># ============================================================================</span>
<span class="c1"># Data Classes</span>
<span class="c1"># ============================================================================</span>

<div class="viewcode-block" id="ColorRecord">
<a class="viewcode-back" href="../../api/color_tools.palette.html#color_tools.palette.ColorRecord">[docs]</a>
<span class="nd">@dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">ColorRecord</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Immutable record representing a named CSS color with precomputed color space values.</span>
<span class="sd">    </span>
<span class="sd">    This dataclass is frozen (immutable) - once created, you can&#39;t change it.</span>
<span class="sd">    This is perfect for colors: a color IS what it IS! ðŸŽ¨</span>
<span class="sd">    </span>
<span class="sd">    All color space values are precomputed and stored for fast access without</span>
<span class="sd">    conversion overhead. The source field tracks which JSON file provided this</span>
<span class="sd">    color, enabling user override detection and debugging.</span>
<span class="sd">    </span>
<span class="sd">    Attributes:</span>
<span class="sd">        name: Color name (e.g., &quot;coral&quot;, &quot;lightblue&quot;, &quot;darkslategray&quot;)</span>
<span class="sd">        hex: Hex color code with # prefix (e.g., &quot;#FF7F50&quot;)</span>
<span class="sd">        rgb: RGB color tuple with values 0-255 (e.g., (255, 127, 80))</span>
<span class="sd">        hsl: HSL color tuple (H: 0-360Â°, S: 0-100%, L: 0-100%)</span>
<span class="sd">        lab: CIE LAB color tuple (L: 0-100, a: ~-128 to +127, b: ~-128 to +127)</span>
<span class="sd">        lch: CIE LCH color tuple (L: 0-100, C: 0-100+, H: 0-360Â°)</span>
<span class="sd">        source: JSON filename where this record originated (default: &quot;colors.json&quot;)</span>
<span class="sd">    </span>
<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; from color_tools import Palette</span>
<span class="sd">        &gt;&gt;&gt; palette = Palette.load_default()</span>
<span class="sd">        &gt;&gt;&gt; color = palette.get_by_name(&quot;coral&quot;)</span>
<span class="sd">        &gt;&gt;&gt; print(f&quot;{color.name}: RGB{color.rgb}&quot;)</span>
<span class="sd">        coral: RGB(255, 127, 80)</span>
<span class="sd">        &gt;&gt;&gt; print(f&quot;LAB: {color.lab}&quot;)</span>
<span class="sd">        LAB: (67.29, 44.61, 49.72)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="nb">hex</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">rgb</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span>
    <span class="n">hsl</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span>   <span class="c1"># (HÂ°, S%, L%)</span>
    <span class="n">lab</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span>   <span class="c1"># (L*, a*, b*)</span>
    <span class="n">lch</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span>   <span class="c1"># (L*, C*, HÂ°)</span>
    <span class="n">source</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;colors.json&quot;</span>      <span class="c1"># JSON filename where this record originated</span>
    
<div class="viewcode-block" id="ColorRecord.__str__">
<a class="viewcode-back" href="../../api/color_tools.palette.html#color_tools.palette.ColorRecord.__str__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Human-readable color representation: name (#hex)&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">hex</span><span class="si">}</span><span class="s2">)&quot;</span></div>
</div>



<div class="viewcode-block" id="FilamentRecord">
<a class="viewcode-back" href="../../api/color_tools.palette.html#color_tools.palette.FilamentRecord">[docs]</a>
<span class="nd">@dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">FilamentRecord</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Immutable record representing a 3D printing filament color.</span>
<span class="sd">    </span>
<span class="sd">    This dataclass handles both single-color and dual-color filaments (like silk/rainbow</span>
<span class="sd">    filaments with two twisted colors). The rgb property intelligently handles dual-color</span>
<span class="sd">    hex codes (e.g., &quot;#AABBCC-#DDEEFF&quot;) based on the global dual_color_mode setting.</span>
<span class="sd">    </span>
<span class="sd">    The source field tracks which JSON file provided this filament, enabling user</span>
<span class="sd">    override detection and debugging.</span>
<span class="sd">    </span>
<span class="sd">    Attributes:</span>
<span class="sd">        id: Unique identifier slug (e.g., &quot;bambu-lab-pla-silk-plus-red&quot;)</span>
<span class="sd">        maker: Manufacturer name (e.g., &quot;Bambu Lab&quot;, &quot;Polymaker&quot;, &quot;Prusament&quot;)</span>
<span class="sd">        type: Filament material type (e.g., &quot;PLA&quot;, &quot;PETG&quot;, &quot;ABS&quot;)</span>
<span class="sd">        finish: Surface finish type (e.g., &quot;Matte&quot;, &quot;Silk&quot;, &quot;PolyMax&quot;) or None</span>
<span class="sd">        color: Color name as labeled by manufacturer (e.g., &quot;Jet Black&quot;, &quot;Signal Red&quot;)</span>
<span class="sd">        hex: Hex color code with # prefix, may contain dash for dual colors (e.g., &quot;#333333-#666666&quot;)</span>
<span class="sd">        td_value: Light transmission depth - how much light passes through the filament.</span>
<span class="sd">            Used for HueForge 3D printing to model light transmission through layers.</span>
<span class="sd">            Most filaments: 0-10 (opaque to slightly translucent)</span>
<span class="sd">            Transparent/clear filaments: ~100</span>
<span class="sd">            Scale is open-ended and can exceed 100 for highly transparent materials.</span>
<span class="sd">            None indicates opaque or unknown transmission characteristics.</span>
<span class="sd">        other_names: Alternative color names (regional variants, historical names) or None</span>
<span class="sd">        source: JSON filename where this record originated (default: &quot;filaments.json&quot;)</span>
<span class="sd">    </span>
<span class="sd">    Properties:</span>
<span class="sd">        rgb: RGB tuple (0-255 each) computed from hex, handles dual-color filaments</span>
<span class="sd">            based on dual_color_mode (&quot;first&quot;, &quot;last&quot;, or &quot;mix&quot;)</span>
<span class="sd">        lab: CIE LAB tuple computed on-demand from RGB</span>
<span class="sd">        lch: CIE LCH tuple computed on-demand from RGB</span>
<span class="sd">    </span>
<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; from color_tools import FilamentPalette</span>
<span class="sd">        &gt;&gt;&gt; palette = FilamentPalette.load_default()</span>
<span class="sd">        &gt;&gt;&gt; filament = palette.find_by_maker(&quot;Bambu Lab&quot;, type_name=&quot;PLA&quot;)[0]</span>
<span class="sd">        &gt;&gt;&gt; print(f&quot;{filament.maker} {filament.type} - {filament.color}&quot;)</span>
<span class="sd">        Bambu Lab PLA - Jet Black</span>
<span class="sd">        &gt;&gt;&gt; print(f&quot;RGB: {filament.rgb}, Hex: {filament.hex}&quot;)</span>
<span class="sd">        RGB: (51, 51, 51), Hex: #333333</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">id</span><span class="p">:</span> <span class="nb">str</span>  <span class="c1"># Unique identifier slug (e.g., &quot;bambu-lab-pla-silk-plus-red&quot;)</span>
    <span class="n">maker</span><span class="p">:</span> <span class="nb">str</span>
    <span class="nb">type</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">finish</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
    <span class="n">color</span><span class="p">:</span> <span class="nb">str</span>
    <span class="nb">hex</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">td_value</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Translucency/transparency value</span>
    <span class="n">other_names</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Alternative names (regional, historical, etc.)</span>
    <span class="n">source</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;filaments.json&quot;</span>   <span class="c1"># JSON filename where this record originated</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">rgb</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Convert hex to RGB tuple, handling dual-color filaments.</span>
<span class="sd">        </span>
<span class="sd">        This is where the dual-color magic happens! If hex contains a dash</span>
<span class="sd">        (e.g., &quot;#333333-#666666&quot;), we parse BOTH colors and handle them based</span>
<span class="sd">        on the global dual_color_mode setting:</span>
<span class="sd">        - &quot;first&quot;: Use first color (default)</span>
<span class="sd">        - &quot;last&quot;: Use second color</span>
<span class="sd">        - &quot;mix&quot;: Perceptually blend in LAB space (the proper way!)</span>
<span class="sd">        </span>
<span class="sd">        Returns:</span>
<span class="sd">            RGB tuple (0-255 for each component)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">hex_clean</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hex</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        
        <span class="c1"># Check for dual-color format (e.g., &quot;#333333-#666666&quot;)</span>
        <span class="k">if</span> <span class="s1">&#39;-&#39;</span> <span class="ow">in</span> <span class="n">hex_clean</span><span class="p">:</span>
            <span class="c1"># Split into individual colors and clean them</span>
            <span class="n">hex_parts</span> <span class="o">=</span> <span class="p">[</span><span class="n">h</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">hex_clean</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)]</span>
            
            <span class="c1"># Parse both colors using our existing hex_to_rgb function</span>
            <span class="n">rgb_colors</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">hex_part</span> <span class="ow">in</span> <span class="n">hex_parts</span><span class="p">[:</span><span class="mi">2</span><span class="p">]:</span>  <span class="c1"># Only take first 2 if more exist</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="n">hex_to_rgb</span><span class="p">(</span><span class="n">hex_part</span><span class="p">)</span>
                    <span class="n">rgb_colors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result</span> <span class="k">if</span> <span class="n">result</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
                <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">):</span>
                    <span class="n">rgb_colors</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
            
            <span class="c1"># If we didn&#39;t get 2 valid colors, fall back to first</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">rgb_colors</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">rgb_colors</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">rgb_colors</span> <span class="k">else</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            
            <span class="c1"># Apply dual-color mode (this is where config comes in!)</span>
            <span class="n">mode</span> <span class="o">=</span> <span class="n">get_dual_color_mode</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;last&quot;</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">rgb_colors</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;mix&quot;</span><span class="p">:</span>
                <span class="c1"># Perceptual blend in LAB space! ðŸŒˆ</span>
                <span class="c1"># This is the RIGHT way to blend colors - not in RGB!</span>
                <span class="n">lab1</span> <span class="o">=</span> <span class="n">rgb_to_lab</span><span class="p">(</span><span class="n">rgb_colors</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">lab2</span> <span class="o">=</span> <span class="n">rgb_to_lab</span><span class="p">(</span><span class="n">rgb_colors</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                <span class="c1"># Average in LAB space (perceptually uniform)</span>
                <span class="n">lab_avg</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="p">(</span><span class="n">lab1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">lab2</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">,</span>
                    <span class="p">(</span><span class="n">lab1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">lab2</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">,</span>
                    <span class="p">(</span><span class="n">lab1</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">lab2</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">/</span> <span class="mf">2.0</span>
                <span class="p">)</span>
                <span class="k">return</span> <span class="n">lab_to_rgb</span><span class="p">(</span><span class="n">lab_avg</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>  <span class="c1"># &quot;first&quot; (default)</span>
                <span class="k">return</span> <span class="n">rgb_colors</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        
        <span class="c1"># Single color - use our existing hex_to_rgb function</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">hex_to_rgb</span><span class="p">(</span><span class="n">hex_clean</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">result</span> <span class="k">if</span> <span class="n">result</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">lab</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Convert to LAB color space.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">rgb_to_lab</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rgb</span><span class="p">)</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">lch</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Convert to LCH color space.&quot;&quot;&quot;</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">.conversions</span><span class="w"> </span><span class="kn">import</span> <span class="n">lab_to_lch</span>
        <span class="k">return</span> <span class="n">lab_to_lch</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lab</span><span class="p">)</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">hsl</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Convert to HSL color space.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">rgb_to_hsl</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rgb</span><span class="p">)</span>
    
<div class="viewcode-block" id="FilamentRecord.__str__">
<a class="viewcode-back" href="../../api/color_tools.palette.html#color_tools.palette.FilamentRecord.__str__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Human-readable filament representation: Maker Type Finish - Color (#hex)&quot;&quot;&quot;</span>
        <span class="n">finish_part</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot; </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">finish</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">finish</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">maker</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">type</span><span class="si">}{</span><span class="n">finish_part</span><span class="si">}</span><span class="s2"> - </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">color</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">hex</span><span class="si">}</span><span class="s2">)&quot;</span></div>
</div>



<span class="c1"># ============================================================================</span>
<span class="c1"># Data Loading</span>
<span class="c1"># ============================================================================</span>

<span class="k">def</span><span class="w"> </span><span class="nf">_parse_color_records</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span> <span class="n">source_file</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;JSON data&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">ColorRecord</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Parse a list of color data dictionaries into ColorRecord objects.</span>
<span class="sd">    </span>
<span class="sd">    This is a helper function used by load_colors() and load_palette() to avoid</span>
<span class="sd">    code duplication. It handles the common parsing logic for color JSON data.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        data: List of dictionaries containing color data</span>
<span class="sd">        source_file: Name of the source file for error messages and source tracking.</span>
<span class="sd">                    Should be just the filename (e.g., &#39;colors.json&#39;, &#39;user-colors.json&#39;)</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">        List of ColorRecord objects with source field set to source_file</span>
<span class="sd">    </span>
<span class="sd">    Raises:</span>
<span class="sd">        KeyError: If required keys are missing from the color data</span>
<span class="sd">        ValueError: If color data values are invalid</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">records</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ColorRecord</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="c1"># Extract just the filename from path for source tracking</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>
    <span class="n">source_filename</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">source_file</span><span class="p">)</span><span class="o">.</span><span class="n">name</span> <span class="k">if</span> <span class="n">source_file</span> <span class="o">!=</span> <span class="s2">&quot;JSON data&quot;</span> <span class="k">else</span> <span class="s2">&quot;unknown.json&quot;</span>
    
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Parse color data (all values should be arrays/tuples)</span>
            <span class="c1"># Validate/coerce RGB to int to ensure numeric values</span>
            <span class="n">rgb</span> <span class="o">=</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="s2">&quot;rgb&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">int</span><span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="s2">&quot;rgb&quot;</span><span class="p">][</span><span class="mi">1</span><span class="p">]),</span> <span class="nb">int</span><span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="s2">&quot;rgb&quot;</span><span class="p">][</span><span class="mi">2</span><span class="p">]))</span>
            <span class="n">hsl</span> <span class="o">=</span> <span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="s2">&quot;hsl&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="s2">&quot;hsl&quot;</span><span class="p">][</span><span class="mi">1</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="s2">&quot;hsl&quot;</span><span class="p">][</span><span class="mi">2</span><span class="p">]))</span>
            <span class="n">lab</span> <span class="o">=</span> <span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="s2">&quot;lab&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="s2">&quot;lab&quot;</span><span class="p">][</span><span class="mi">1</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="s2">&quot;lab&quot;</span><span class="p">][</span><span class="mi">2</span><span class="p">]))</span>
            <span class="n">lch</span> <span class="o">=</span> <span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="s2">&quot;lch&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="s2">&quot;lch&quot;</span><span class="p">][</span><span class="mi">1</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="s2">&quot;lch&quot;</span><span class="p">][</span><span class="mi">2</span><span class="p">]))</span>
            
            <span class="n">records</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ColorRecord</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="n">c</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">],</span>
                <span class="nb">hex</span><span class="o">=</span><span class="n">c</span><span class="p">[</span><span class="s2">&quot;hex&quot;</span><span class="p">],</span>
                <span class="n">rgb</span><span class="o">=</span><span class="n">rgb</span><span class="p">,</span>
                <span class="n">hsl</span><span class="o">=</span><span class="n">hsl</span><span class="p">,</span>
                <span class="n">lab</span><span class="o">=</span><span class="n">lab</span><span class="p">,</span>
                <span class="n">lch</span><span class="o">=</span><span class="n">lch</span><span class="p">,</span>
                <span class="n">source</span><span class="o">=</span><span class="n">source_filename</span><span class="p">,</span>
            <span class="p">))</span>
        <span class="k">except</span> <span class="ne">KeyError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Missing required key </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2"> in color at index </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2"> in </span><span class="si">{</span><span class="n">source_file</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="ne">IndexError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Invalid color data at index </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2"> in </span><span class="si">{</span><span class="n">source_file</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>
    
    <span class="k">return</span> <span class="n">records</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_parse_filament_records</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span> <span class="n">source_file</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;JSON data&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">FilamentRecord</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Parse a list of filament data dictionaries into FilamentRecord objects.</span>
<span class="sd">    </span>
<span class="sd">    This is a helper function used by load_filaments() to avoid code duplication</span>
<span class="sd">    and ensure consistent source tracking.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        data: List of dictionaries containing filament data</span>
<span class="sd">        source_file: Name of the source file for error messages and source tracking.</span>
<span class="sd">                    Should be just the filename (e.g., &#39;filaments.json&#39;, &#39;user-filaments.json&#39;)</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">        List of FilamentRecord objects with source field set to source_file</span>
<span class="sd">    </span>
<span class="sd">    Raises:</span>
<span class="sd">        KeyError: If required keys are missing from the filament data</span>
<span class="sd">        ValueError: If filament data values are invalid</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">records</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">FilamentRecord</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="c1"># Extract just the filename from path for source tracking</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>
    <span class="n">source_filename</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">source_file</span><span class="p">)</span><span class="o">.</span><span class="n">name</span> <span class="k">if</span> <span class="n">source_file</span> <span class="o">!=</span> <span class="s2">&quot;JSON data&quot;</span> <span class="k">else</span> <span class="s2">&quot;unknown.json&quot;</span>
    
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">f</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">records</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">FilamentRecord</span><span class="p">(</span>
                <span class="nb">id</span><span class="o">=</span><span class="n">f</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">),</span>  <span class="c1"># User files may not have IDs</span>
                <span class="n">maker</span><span class="o">=</span><span class="n">f</span><span class="p">[</span><span class="s2">&quot;maker&quot;</span><span class="p">],</span>
                <span class="nb">type</span><span class="o">=</span><span class="n">f</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">],</span>
                <span class="n">finish</span><span class="o">=</span><span class="n">f</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;finish&quot;</span><span class="p">),</span>
                <span class="n">color</span><span class="o">=</span><span class="n">f</span><span class="p">[</span><span class="s2">&quot;color&quot;</span><span class="p">],</span>
                <span class="nb">hex</span><span class="o">=</span><span class="n">f</span><span class="p">[</span><span class="s2">&quot;hex&quot;</span><span class="p">],</span>
                <span class="n">td_value</span><span class="o">=</span><span class="n">f</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;td_value&quot;</span><span class="p">),</span>
                <span class="n">other_names</span><span class="o">=</span><span class="n">f</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;other_names&quot;</span><span class="p">),</span>
                <span class="n">source</span><span class="o">=</span><span class="n">source_filename</span><span class="p">,</span>
            <span class="p">))</span>
        <span class="k">except</span> <span class="ne">KeyError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Missing required key </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2"> in filament at index </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2"> in </span><span class="si">{</span><span class="n">source_file</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Invalid filament data at index </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2"> in </span><span class="si">{</span><span class="n">source_file</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>
    
    <span class="k">return</span> <span class="n">records</span>


<div class="viewcode-block" id="load_colors">
<a class="viewcode-back" href="../../api/color_tools.palette.html#color_tools.palette.load_colors">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">load_colors</span><span class="p">(</span><span class="n">json_path</span><span class="p">:</span> <span class="n">Path</span> <span class="o">|</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">ColorRecord</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Load CSS color database from JSON files (core + user additions).</span>
<span class="sd">    </span>
<span class="sd">    Loads colors from both the core colors.json file and optional user/user-colors.json</span>
<span class="sd">    file in the data directory. Core colors are loaded first, followed by user colors.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        json_path: Path to directory containing JSON files, or path to specific</span>
<span class="sd">                   colors JSON file. If None, looks for colors.json in the </span>
<span class="sd">                   package&#39;s data/ directory.</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">        List of ColorRecord objects (core colors + user colors)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">json_path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># Default: look in package&#39;s data/ directory</span>
        <span class="n">data_dir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span><span class="o">.</span><span class="n">parent</span> <span class="o">/</span> <span class="s2">&quot;data&quot;</span>
        <span class="n">json_path</span> <span class="o">=</span> <span class="n">data_dir</span> <span class="o">/</span> <span class="n">ColorConstants</span><span class="o">.</span><span class="n">COLORS_JSON_FILENAME</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">json_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">json_path</span><span class="p">)</span>
        <span class="c1"># If it&#39;s a directory, append the filename</span>
        <span class="k">if</span> <span class="n">json_path</span><span class="o">.</span><span class="n">is_dir</span><span class="p">():</span>
            <span class="n">data_dir</span> <span class="o">=</span> <span class="n">json_path</span>
            <span class="n">json_path</span> <span class="o">=</span> <span class="n">json_path</span> <span class="o">/</span> <span class="n">ColorConstants</span><span class="o">.</span><span class="n">COLORS_JSON_FILENAME</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">data_dir</span> <span class="o">=</span> <span class="n">json_path</span><span class="o">.</span><span class="n">parent</span>
    
    <span class="c1"># Load core colors</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">json_path</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    
    <span class="c1"># Data should be an array of color objects at the root level</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Expected array of colors at root level in </span><span class="si">{</span><span class="n">json_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="c1"># Parse color records using helper function</span>
    <span class="n">records</span> <span class="o">=</span> <span class="n">_parse_color_records</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">json_path</span><span class="p">))</span>
    
    <span class="c1"># Load optional user colors from same directory</span>
    <span class="n">user_json_path</span> <span class="o">=</span> <span class="n">data_dir</span> <span class="o">/</span> <span class="n">ColorConstants</span><span class="o">.</span><span class="n">USER_COLORS_JSON_FILENAME</span>
    <span class="k">if</span> <span class="n">user_json_path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">user_json_path</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">user_data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">user_data</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Expected array of colors at root level in </span><span class="si">{</span><span class="n">user_json_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="c1"># Parse user color records using helper function</span>
        <span class="n">user_records</span> <span class="o">=</span> <span class="n">_parse_color_records</span><span class="p">(</span><span class="n">user_data</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">user_json_path</span><span class="p">))</span>
        
        <span class="c1"># Detect and log overrides before merging</span>
        <span class="k">if</span> <span class="n">user_records</span><span class="p">:</span>
            <span class="n">core_names</span> <span class="o">=</span> <span class="p">{</span><span class="n">r</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span> <span class="n">r</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">records</span><span class="p">}</span>
            <span class="n">core_rgbs</span> <span class="o">=</span> <span class="p">{</span><span class="n">r</span><span class="o">.</span><span class="n">rgb</span><span class="p">:</span> <span class="n">r</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">records</span><span class="p">}</span>
            
            <span class="n">name_overrides</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">rgb_overrides</span> <span class="o">=</span> <span class="p">[]</span>
            
            <span class="k">for</span> <span class="n">user_record</span> <span class="ow">in</span> <span class="n">user_records</span><span class="p">:</span>
                <span class="c1"># Check for name conflicts</span>
                <span class="k">if</span> <span class="n">user_record</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="n">core_names</span><span class="p">:</span>
                    <span class="n">core_record</span> <span class="o">=</span> <span class="n">core_names</span><span class="p">[</span><span class="n">user_record</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span>
                    <span class="n">name_overrides</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">user_record</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">core_record</span><span class="o">.</span><span class="n">source</span><span class="p">,</span> <span class="n">user_record</span><span class="o">.</span><span class="n">source</span><span class="p">))</span>
                
                <span class="c1"># Check for RGB conflicts (different records with same RGB)</span>
                <span class="k">if</span> <span class="n">user_record</span><span class="o">.</span><span class="n">rgb</span> <span class="ow">in</span> <span class="n">core_rgbs</span><span class="p">:</span>
                    <span class="n">core_record</span> <span class="o">=</span> <span class="n">core_rgbs</span><span class="p">[</span><span class="n">user_record</span><span class="o">.</span><span class="n">rgb</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">core_record</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">!=</span> <span class="n">user_record</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>  <span class="c1"># Different names, same RGB</span>
                        <span class="n">rgb_overrides</span><span class="o">.</span><span class="n">append</span><span class="p">((</span>
                            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">user_record</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">user_record</span><span class="o">.</span><span class="n">rgb</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">core_record</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">core_record</span><span class="o">.</span><span class="n">source</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">,</span>
                            <span class="n">user_record</span><span class="o">.</span><span class="n">source</span>
                        <span class="p">))</span>
            
            <span class="c1"># Log override information</span>
            <span class="k">if</span> <span class="n">name_overrides</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;User colors override </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">name_overrides</span><span class="p">)</span><span class="si">}</span><span class="s2"> core colors by name: </span><span class="si">{</span><span class="n">name_overrides</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">rgb_overrides</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;User colors override </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">rgb_overrides</span><span class="p">)</span><span class="si">}</span><span class="s2"> core colors by RGB: </span><span class="si">{</span><span class="n">rgb_overrides</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="n">records</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">user_records</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">records</span></div>



<div class="viewcode-block" id="load_filaments">
<a class="viewcode-back" href="../../api/color_tools.palette.html#color_tools.palette.load_filaments">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">load_filaments</span><span class="p">(</span><span class="n">json_path</span><span class="p">:</span> <span class="n">Path</span> <span class="o">|</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">FilamentRecord</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Load filament database from JSON files (core + user additions).</span>
<span class="sd">    </span>
<span class="sd">    Loads filaments from both the core filaments.json file and optional </span>
<span class="sd">    user/user-filaments.json file in the data directory. Core filaments are loaded </span>
<span class="sd">    first, followed by user filaments.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        json_path: Path to directory containing JSON files, or path to specific</span>
<span class="sd">                   filaments JSON file. If None, looks for filaments.json in </span>
<span class="sd">                   the package&#39;s data/ directory.</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">        List of FilamentRecord objects (core filaments + user filaments)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">json_path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># Default: look in package&#39;s data/ directory</span>
        <span class="n">data_dir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span><span class="o">.</span><span class="n">parent</span> <span class="o">/</span> <span class="s2">&quot;data&quot;</span>
        <span class="n">json_path</span> <span class="o">=</span> <span class="n">data_dir</span> <span class="o">/</span> <span class="n">ColorConstants</span><span class="o">.</span><span class="n">FILAMENTS_JSON_FILENAME</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">json_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">json_path</span><span class="p">)</span>
        <span class="c1"># If it&#39;s a directory, append the filename</span>
        <span class="k">if</span> <span class="n">json_path</span><span class="o">.</span><span class="n">is_dir</span><span class="p">():</span>
            <span class="n">data_dir</span> <span class="o">=</span> <span class="n">json_path</span>
            <span class="n">json_path</span> <span class="o">=</span> <span class="n">json_path</span> <span class="o">/</span> <span class="n">ColorConstants</span><span class="o">.</span><span class="n">FILAMENTS_JSON_FILENAME</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">data_dir</span> <span class="o">=</span> <span class="n">json_path</span><span class="o">.</span><span class="n">parent</span>
    
    <span class="c1"># Load core filaments</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">json_path</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    
    <span class="c1"># Data should be an array of filament objects at the root level</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Expected array of filaments at root level in </span><span class="si">{</span><span class="n">json_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="c1"># Parse core filament records using helper function</span>
    <span class="n">records</span> <span class="o">=</span> <span class="n">_parse_filament_records</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">json_path</span><span class="p">))</span>
    
    <span class="c1"># Load optional user filaments from same directory</span>
    <span class="n">user_json_path</span> <span class="o">=</span> <span class="n">data_dir</span> <span class="o">/</span> <span class="n">ColorConstants</span><span class="o">.</span><span class="n">USER_FILAMENTS_JSON_FILENAME</span>
    <span class="k">if</span> <span class="n">user_json_path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">user_json_path</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">user_data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">user_data</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Expected array of filaments at root level in </span><span class="si">{</span><span class="n">user_json_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="c1"># Parse user filament records using helper function</span>
        <span class="n">user_records</span> <span class="o">=</span> <span class="n">_parse_filament_records</span><span class="p">(</span><span class="n">user_data</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">user_json_path</span><span class="p">))</span>
        
        <span class="c1"># Detect and log overrides before merging</span>
        <span class="k">if</span> <span class="n">user_records</span><span class="p">:</span>
            <span class="c1"># For filaments, we consider a conflict when maker+type+color+hex all match</span>
            <span class="n">core_sigs</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">records</span><span class="p">:</span>
                <span class="n">sig</span> <span class="o">=</span> <span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">maker</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">color</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">hex</span><span class="p">)</span>
                <span class="n">core_sigs</span><span class="p">[</span><span class="n">sig</span><span class="p">]</span> <span class="o">=</span> <span class="n">r</span>
            
            <span class="n">exact_overrides</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">rgb_overrides</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">core_rgbs</span> <span class="o">=</span> <span class="p">{</span><span class="n">r</span><span class="o">.</span><span class="n">rgb</span><span class="p">:</span> <span class="n">r</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">records</span><span class="p">}</span>
            
            <span class="k">for</span> <span class="n">user_record</span> <span class="ow">in</span> <span class="n">user_records</span><span class="p">:</span>
                <span class="c1"># Check for exact filament match (same maker+type+color+hex)</span>
                <span class="n">user_sig</span> <span class="o">=</span> <span class="p">(</span><span class="n">user_record</span><span class="o">.</span><span class="n">maker</span><span class="p">,</span> <span class="n">user_record</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="n">user_record</span><span class="o">.</span><span class="n">color</span><span class="p">,</span> <span class="n">user_record</span><span class="o">.</span><span class="n">hex</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">user_sig</span> <span class="ow">in</span> <span class="n">core_sigs</span><span class="p">:</span>
                    <span class="n">core_record</span> <span class="o">=</span> <span class="n">core_sigs</span><span class="p">[</span><span class="n">user_sig</span><span class="p">]</span>
                    <span class="n">exact_overrides</span><span class="o">.</span><span class="n">append</span><span class="p">((</span>
                        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">user_record</span><span class="o">.</span><span class="n">maker</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">user_record</span><span class="o">.</span><span class="n">type</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">user_record</span><span class="o">.</span><span class="n">color</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                        <span class="n">core_record</span><span class="o">.</span><span class="n">source</span><span class="p">,</span>
                        <span class="n">user_record</span><span class="o">.</span><span class="n">source</span>
                    <span class="p">))</span>
                
                <span class="c1"># Check for RGB conflicts (different filaments with same RGB)</span>
                <span class="k">elif</span> <span class="n">user_record</span><span class="o">.</span><span class="n">rgb</span> <span class="ow">in</span> <span class="n">core_rgbs</span><span class="p">:</span>
                    <span class="n">core_record</span> <span class="o">=</span> <span class="n">core_rgbs</span><span class="p">[</span><span class="n">user_record</span><span class="o">.</span><span class="n">rgb</span><span class="p">]</span>
                    <span class="n">rgb_overrides</span><span class="o">.</span><span class="n">append</span><span class="p">((</span>
                        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">user_record</span><span class="o">.</span><span class="n">maker</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">user_record</span><span class="o">.</span><span class="n">type</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">user_record</span><span class="o">.</span><span class="n">color</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">user_record</span><span class="o">.</span><span class="n">rgb</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">core_record</span><span class="o">.</span><span class="n">maker</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">core_record</span><span class="o">.</span><span class="n">type</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">core_record</span><span class="o">.</span><span class="n">color</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">core_record</span><span class="o">.</span><span class="n">source</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">,</span>
                        <span class="n">user_record</span><span class="o">.</span><span class="n">source</span>
                    <span class="p">))</span>
            
            <span class="c1"># Log override information</span>
            <span class="k">if</span> <span class="n">exact_overrides</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;User filaments override </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">exact_overrides</span><span class="p">)</span><span class="si">}</span><span class="s2"> core filaments exactly: </span><span class="si">{</span><span class="n">exact_overrides</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">rgb_overrides</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;User filaments override </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">rgb_overrides</span><span class="p">)</span><span class="si">}</span><span class="s2"> core filaments by RGB: </span><span class="si">{</span><span class="n">rgb_overrides</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="n">records</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">user_records</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">records</span></div>



<div class="viewcode-block" id="load_maker_synonyms">
<a class="viewcode-back" href="../../api/color_tools.palette.html#color_tools.palette.load_maker_synonyms">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">load_maker_synonyms</span><span class="p">(</span><span class="n">json_path</span><span class="p">:</span> <span class="n">Path</span> <span class="o">|</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Load maker synonyms from JSON files (core + user additions).</span>
<span class="sd">    </span>
<span class="sd">    Loads synonyms from both the core maker_synonyms.json file and optional</span>
<span class="sd">    user/user-synonyms.json file in the data directory. Synonyms are merged, with</span>
<span class="sd">    user additions extending or replacing core synonyms per maker.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        json_path: Path to directory containing JSON files, or path to specific</span>
<span class="sd">                   maker_synonyms JSON file. If None, looks for maker_synonyms.json </span>
<span class="sd">                   in the package&#39;s data/ directory.</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">        Dictionary mapping canonical maker names to lists of synonyms</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">json_path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># Default: look in package&#39;s data/ directory</span>
        <span class="n">data_dir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span><span class="o">.</span><span class="n">parent</span> <span class="o">/</span> <span class="s2">&quot;data&quot;</span>
        <span class="n">json_path</span> <span class="o">=</span> <span class="n">data_dir</span> <span class="o">/</span> <span class="n">ColorConstants</span><span class="o">.</span><span class="n">MAKER_SYNONYMS_JSON_FILENAME</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">json_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">json_path</span><span class="p">)</span>
        <span class="c1"># If it&#39;s a directory, append the filename</span>
        <span class="k">if</span> <span class="n">json_path</span><span class="o">.</span><span class="n">is_dir</span><span class="p">():</span>
            <span class="n">data_dir</span> <span class="o">=</span> <span class="n">json_path</span>
            <span class="n">json_path</span> <span class="o">=</span> <span class="n">json_path</span> <span class="o">/</span> <span class="n">ColorConstants</span><span class="o">.</span><span class="n">MAKER_SYNONYMS_JSON_FILENAME</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">data_dir</span> <span class="o">=</span> <span class="n">json_path</span><span class="o">.</span><span class="n">parent</span>
    
    <span class="c1"># Load core synonyms</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">json_path</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">synonyms</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
        <span class="n">synonyms</span> <span class="o">=</span> <span class="p">{}</span>
    
    <span class="c1"># Load optional user synonyms from same directory and merge</span>
    <span class="n">user_json_path</span> <span class="o">=</span> <span class="n">data_dir</span> <span class="o">/</span> <span class="n">ColorConstants</span><span class="o">.</span><span class="n">USER_SYNONYMS_JSON_FILENAME</span>
    <span class="k">if</span> <span class="n">user_json_path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">user_json_path</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">user_synonyms</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        
        <span class="c1"># Log synonym overrides before merging</span>
        <span class="n">overridden_makers</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">extended_makers</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="c1"># Merge user synonyms into core synonyms</span>
        <span class="k">for</span> <span class="n">maker</span><span class="p">,</span> <span class="n">user_syn_list</span> <span class="ow">in</span> <span class="n">user_synonyms</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">maker</span> <span class="ow">in</span> <span class="n">synonyms</span><span class="p">:</span>
                <span class="c1"># Check if user completely replaces or extends existing synonyms</span>
                <span class="n">existing</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">synonyms</span><span class="p">[</span><span class="n">maker</span><span class="p">])</span>
                <span class="n">new_synonyms</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">user_syn_list</span><span class="p">)</span>
                
                <span class="k">if</span> <span class="n">existing</span> <span class="o">==</span> <span class="n">new_synonyms</span><span class="p">:</span>
                    <span class="c1"># Same synonyms - no conflict</span>
                    <span class="k">continue</span>
                <span class="k">elif</span> <span class="n">existing</span><span class="o">.</span><span class="n">isdisjoint</span><span class="p">(</span><span class="n">new_synonyms</span><span class="p">):</span>
                    <span class="c1"># Completely different - user replaces core synonyms</span>
                    <span class="n">overridden_makers</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">maker</span><span class="p">,</span> <span class="n">synonyms</span><span class="p">[</span><span class="n">maker</span><span class="p">],</span> <span class="n">user_syn_list</span><span class="p">))</span>
                    <span class="n">synonyms</span><span class="p">[</span><span class="n">maker</span><span class="p">]</span> <span class="o">=</span> <span class="n">user_syn_list</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># Some overlap - extend existing synonym list (avoid duplicates)</span>
                    <span class="n">original_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">synonyms</span><span class="p">[</span><span class="n">maker</span><span class="p">])</span>
                    <span class="k">for</span> <span class="n">syn</span> <span class="ow">in</span> <span class="n">user_syn_list</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">syn</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">existing</span><span class="p">:</span>
                            <span class="n">synonyms</span><span class="p">[</span><span class="n">maker</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">syn</span><span class="p">)</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">synonyms</span><span class="p">[</span><span class="n">maker</span><span class="p">])</span> <span class="o">&gt;</span> <span class="n">original_count</span><span class="p">:</span>
                        <span class="n">extended_makers</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">maker</span><span class="p">,</span> <span class="n">original_count</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">synonyms</span><span class="p">[</span><span class="n">maker</span><span class="p">])))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Add new maker with their synonyms</span>
                <span class="n">synonyms</span><span class="p">[</span><span class="n">maker</span><span class="p">]</span> <span class="o">=</span> <span class="n">user_syn_list</span>
        
        <span class="c1"># Log override information</span>
        <span class="k">if</span> <span class="n">overridden_makers</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;User synonyms override </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">overridden_makers</span><span class="p">)</span><span class="si">}</span><span class="s2"> core makers: </span><span class="si">{</span><span class="p">[(</span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="sa">f</span><span class="s1">&#39;core: </span><span class="si">{</span><span class="n">c</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span><span class="w"> </span><span class="sa">f</span><span class="s1">&#39;user: </span><span class="si">{</span><span class="n">u</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="n">c</span><span class="p">,</span><span class="w"> </span><span class="n">u</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">overridden_makers</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">extended_makers</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;User synonyms extend </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">extended_makers</span><span class="p">)</span><span class="si">}</span><span class="s2"> core makers: </span><span class="si">{</span><span class="p">[(</span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">old</span><span class="si">}</span><span class="s1">-&gt;</span><span class="si">{</span><span class="n">new</span><span class="si">}</span><span class="s1"> synonyms&#39;</span><span class="p">)</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="n">old</span><span class="p">,</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">extended_makers</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">synonyms</span></div>



<div class="viewcode-block" id="load_palette">
<a class="viewcode-back" href="../../api/color_tools.palette.html#color_tools.palette.load_palette">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">load_palette</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">json_path</span><span class="p">:</span> <span class="s2">&quot;Path | str | None&quot;</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;Palette&#39;</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Load a named retro palette from the palettes directory.</span>
<span class="sd">    </span>
<span class="sd">    Palettes are loaded from:</span>
<span class="sd">    1. User palettes: data/user/palettes/{name}.json (if exists)  </span>
<span class="sd">    2. Core palettes: data/palettes/{name}.json (built-in)</span>
<span class="sd">    </span>
<span class="sd">    User palettes override core palettes with the same name.</span>
<span class="sd">    </span>
<span class="sd">    Common built-in palettes include:</span>
<span class="sd">    - cga4: CGA 4-color palette (Palette 1, high intensity) - classic gaming!</span>
<span class="sd">    - cga16: CGA 16-color palette (full RGBI)</span>
<span class="sd">    - ega16: EGA 16-color palette (standard/default)</span>
<span class="sd">    - ega64: EGA 64-color palette (full 6-bit RGB)</span>
<span class="sd">    - vga: VGA 256-color palette (Mode 13h)</span>
<span class="sd">    - web: Web-safe 216-color palette (6x6x6 RGB cube)</span>
<span class="sd">    - gameboy: Game Boy 4-shade green palette</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        name: Palette name (e.g., &#39;cga4&#39;, &#39;ega16&#39;, &#39;vga&#39;, &#39;web&#39;, or custom user palette)</span>
<span class="sd">        json_path: Optional custom data directory. If None, uses package default.</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">        Palette object loaded from the specified palette file</span>
<span class="sd">    </span>
<span class="sd">    Raises:</span>
<span class="sd">        FileNotFoundError: If the palette file doesn&#39;t exist</span>
<span class="sd">        ValueError: If the palette file is malformed or contains invalid data</span>
<span class="sd">    </span>
<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; cga = load_palette(&quot;cga4&quot;)</span>
<span class="sd">        &gt;&gt;&gt; color, dist = cga.nearest_color((128, 64, 200))</span>
<span class="sd">        &gt;&gt;&gt; print(f&quot;Nearest CGA color: {color.name}&quot;)</span>
<span class="sd">        </span>
<span class="sd">        &gt;&gt;&gt; # Load custom user palette</span>
<span class="sd">        &gt;&gt;&gt; custom = load_palette(&quot;my_custom_palette&quot;)</span>
<span class="sd">        &gt;&gt;&gt; print(f&quot;Loaded {len(custom.records)} colors from user palette&quot;)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Determine data directory</span>
    <span class="k">if</span> <span class="n">json_path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">data_dir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span><span class="o">.</span><span class="n">parent</span> <span class="o">/</span> <span class="s2">&quot;data&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">data_dir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">json_path</span><span class="p">)</span>
    
    <span class="c1"># Determine palette file location</span>
    <span class="n">palette_file</span> <span class="o">=</span> <span class="kc">None</span>
    
    <span class="k">if</span> <span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;user-&quot;</span><span class="p">):</span>
        <span class="c1"># User palette requested</span>
        <span class="n">user_palette_file</span> <span class="o">=</span> <span class="n">data_dir</span> <span class="o">/</span> <span class="s2">&quot;user&quot;</span> <span class="o">/</span> <span class="s2">&quot;palettes&quot;</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">.json&quot;</span>
        <span class="k">if</span> <span class="n">user_palette_file</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="n">palette_file</span> <span class="o">=</span> <span class="n">user_palette_file</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Core palette requested</span>
        <span class="n">core_palette_file</span> <span class="o">=</span> <span class="n">data_dir</span> <span class="o">/</span> <span class="s2">&quot;palettes&quot;</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">.json&quot;</span>
        <span class="k">if</span> <span class="n">core_palette_file</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="n">palette_file</span> <span class="o">=</span> <span class="n">core_palette_file</span>
    
    <span class="k">if</span> <span class="n">palette_file</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># Build list of available palettes from both locations</span>
        <span class="n">available</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="c1"># Core palettes</span>
        <span class="n">core_palettes_dir</span> <span class="o">=</span> <span class="n">data_dir</span> <span class="o">/</span> <span class="s2">&quot;palettes&quot;</span>
        <span class="k">if</span> <span class="n">core_palettes_dir</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="n">available</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">p</span><span class="o">.</span><span class="n">stem</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">core_palettes_dir</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;*.json&quot;</span><span class="p">)])</span>
        
        <span class="c1"># User palettes (only user-*.json files)</span>
        <span class="n">user_palettes_dir</span> <span class="o">=</span> <span class="n">data_dir</span> <span class="o">/</span> <span class="s2">&quot;user&quot;</span> <span class="o">/</span> <span class="s2">&quot;palettes&quot;</span>
        <span class="k">if</span> <span class="n">user_palettes_dir</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="n">user_palettes</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">stem</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">user_palettes_dir</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;user-*.json&quot;</span><span class="p">)]</span>
            <span class="n">available</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">user_palettes</span><span class="p">)</span>
        
        <span class="n">available</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
        
        <span class="c1"># Check if there&#39;s a non-prefixed file that user might be trying to access</span>
        <span class="n">error_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Palette &#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; not found. Available palettes: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">available</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;user-&quot;</span><span class="p">):</span>
            <span class="n">non_prefixed_file</span> <span class="o">=</span> <span class="n">data_dir</span> <span class="o">/</span> <span class="s2">&quot;user&quot;</span> <span class="o">/</span> <span class="s2">&quot;palettes&quot;</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">.json&quot;</span>
            <span class="k">if</span> <span class="n">non_prefixed_file</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                <span class="n">error_msg</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Note: File &#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">.json&#39; exists in user/palettes/ but must be named &#39;user-</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">.json&#39; to be accessible.&quot;</span>
        
        <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span>
    
    <span class="c1"># Load the palette JSON data</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">palette_file</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">json</span><span class="o">.</span><span class="n">JSONDecodeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid JSON in palette file </span><span class="si">{</span><span class="n">palette_file</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>
    
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Expected array of colors at root level in </span><span class="si">{</span><span class="n">palette_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="c1"># Parse color records using shared helper function</span>
    <span class="n">records</span> <span class="o">=</span> <span class="n">_parse_color_records</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">palette_file</span><span class="p">))</span>
    
    <span class="k">return</span> <span class="n">Palette</span><span class="p">(</span><span class="n">records</span><span class="p">)</span></div>




<span class="c1"># ============================================================================</span>
<span class="c1"># Helper Functions</span>
<span class="c1"># ============================================================================</span>

<span class="k">def</span><span class="w"> </span><span class="nf">_rounded_key</span><span class="p">(</span><span class="n">nums</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="o">...</span><span class="p">],</span> <span class="n">ndigits</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">2</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create a string key from rounded numeric values.</span>
<span class="sd">    </span>
<span class="sd">    Used for fuzzy matching in dictionaries. Instead of looking for</span>
<span class="sd">    EXACTLY (50.0, 25.0, 100.0), we round to (50.00, 25.00, 100.00)</span>
<span class="sd">    so nearby values will match.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">ndigits</span><span class="p">))</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">nums</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">_ensure_list</span><span class="p">(</span><span class="n">value</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Ensures the input is a list of strings, wrapping if it&#39;s a single string.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">value</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">value</span>

<span class="c1"># ============================================================================</span>
<span class="c1"># Palette Classes</span>
<span class="c1"># ============================================================================</span>

<div class="viewcode-block" id="Palette">
<a class="viewcode-back" href="../../api/color_tools.palette.html#color_tools.palette.Palette">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">Palette</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    CSS color palette with multiple indexing strategies for fast lookup.</span>
<span class="sd">    </span>
<span class="sd">    Think of this as a database with multiple indexes. Want to find a color</span>
<span class="sd">    by name? O(1). By RGB? O(1). By LAB? O(1). The tradeoff is memory -</span>
<span class="sd">    we keep multiple dictionaries pointing to the same ColorRecords.</span>
<span class="sd">    </span>
<span class="sd">    For a palette with ~150 CSS colors, this is totally fine! ðŸš€</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
<div class="viewcode-block" id="Palette.__init__">
<a class="viewcode-back" href="../../api/color_tools.palette.html#color_tools.palette.Palette.__init__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">records</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ColorRecord</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">records</span> <span class="o">=</span> <span class="n">records</span>
        
        <span class="c1"># Build multiple indices for O(1) lookups with user override priority</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_by_name</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">ColorRecord</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_by_rgb</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span> <span class="n">ColorRecord</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_by_hsl</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">ColorRecord</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_by_lab</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">ColorRecord</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_by_lch</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">ColorRecord</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        
        <span class="c1"># Populate indices with override priority</span>
        <span class="k">for</span> <span class="n">record</span> <span class="ow">in</span> <span class="n">records</span><span class="p">:</span>
            <span class="n">name_key</span> <span class="o">=</span> <span class="n">record</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            <span class="n">hsl_key</span> <span class="o">=</span> <span class="n">_rounded_key</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">hsl</span><span class="p">)</span>
            <span class="n">lab_key</span> <span class="o">=</span> <span class="n">_rounded_key</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">lab</span><span class="p">)</span>
            <span class="n">lch_key</span> <span class="o">=</span> <span class="n">_rounded_key</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">lch</span><span class="p">)</span>
            
            <span class="c1"># For each index, check if we should override existing entry</span>
            <span class="k">if</span> <span class="n">name_key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_by_name</span> <span class="ow">or</span> <span class="n">_should_prefer_source</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">source</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_by_name</span><span class="p">[</span><span class="n">name_key</span><span class="p">]</span><span class="o">.</span><span class="n">source</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_by_name</span><span class="p">[</span><span class="n">name_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">record</span>
                
            <span class="k">if</span> <span class="n">record</span><span class="o">.</span><span class="n">rgb</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_by_rgb</span> <span class="ow">or</span> <span class="n">_should_prefer_source</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">source</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_by_rgb</span><span class="p">[</span><span class="n">record</span><span class="o">.</span><span class="n">rgb</span><span class="p">]</span><span class="o">.</span><span class="n">source</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_by_rgb</span><span class="p">[</span><span class="n">record</span><span class="o">.</span><span class="n">rgb</span><span class="p">]</span> <span class="o">=</span> <span class="n">record</span>
                
            <span class="k">if</span> <span class="n">hsl_key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_by_hsl</span> <span class="ow">or</span> <span class="n">_should_prefer_source</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">source</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_by_hsl</span><span class="p">[</span><span class="n">hsl_key</span><span class="p">]</span><span class="o">.</span><span class="n">source</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_by_hsl</span><span class="p">[</span><span class="n">hsl_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">record</span>
                
            <span class="k">if</span> <span class="n">lab_key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_by_lab</span> <span class="ow">or</span> <span class="n">_should_prefer_source</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">source</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_by_lab</span><span class="p">[</span><span class="n">lab_key</span><span class="p">]</span><span class="o">.</span><span class="n">source</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_by_lab</span><span class="p">[</span><span class="n">lab_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">record</span>
                
            <span class="k">if</span> <span class="n">lch_key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_by_lch</span> <span class="ow">or</span> <span class="n">_should_prefer_source</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">source</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_by_lch</span><span class="p">[</span><span class="n">lch_key</span><span class="p">]</span><span class="o">.</span><span class="n">source</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_by_lch</span><span class="p">[</span><span class="n">lch_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">record</span></div>

    
<div class="viewcode-block" id="Palette.load_default">
<a class="viewcode-back" href="../../api/color_tools.palette.html#color_tools.palette.Palette.load_default">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">load_default</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;Palette&#39;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Load the default CSS color palette from the package data.</span>
<span class="sd">        </span>
<span class="sd">        This is a convenience method so you don&#39;t have to worry about</span>
<span class="sd">        file paths - just call Palette.load_default() and go!</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">load_colors</span><span class="p">())</span></div>


<div class="viewcode-block" id="Palette.find_by_name">
<a class="viewcode-back" href="../../api/color_tools.palette.html#color_tools.palette.Palette.find_by_name">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">find_by_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">ColorRecord</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Find color by exact name match (case-insensitive).&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_by_name</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span></div>


<div class="viewcode-block" id="Palette.find_by_rgb">
<a class="viewcode-back" href="../../api/color_tools.palette.html#color_tools.palette.Palette.find_by_rgb">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">find_by_rgb</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rgb</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">ColorRecord</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Find color by exact RGB match.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_by_rgb</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">rgb</span><span class="p">)</span></div>


<div class="viewcode-block" id="Palette.find_by_hsl">
<a class="viewcode-back" href="../../api/color_tools.palette.html#color_tools.palette.Palette.find_by_hsl">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">find_by_hsl</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hsl</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span> <span class="n">rounding</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">2</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">ColorRecord</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Find color by HSL match (with rounding for fuzzy matching).&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_by_hsl</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">_rounded_key</span><span class="p">(</span><span class="n">hsl</span><span class="p">,</span> <span class="n">rounding</span><span class="p">))</span></div>


<div class="viewcode-block" id="Palette.find_by_lab">
<a class="viewcode-back" href="../../api/color_tools.palette.html#color_tools.palette.Palette.find_by_lab">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">find_by_lab</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lab</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span> <span class="n">rounding</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">2</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">ColorRecord</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Find color by LAB match (with rounding for fuzzy matching).&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_by_lab</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">_rounded_key</span><span class="p">(</span><span class="n">lab</span><span class="p">,</span> <span class="n">rounding</span><span class="p">))</span></div>


<div class="viewcode-block" id="Palette.find_by_lch">
<a class="viewcode-back" href="../../api/color_tools.palette.html#color_tools.palette.Palette.find_by_lch">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">find_by_lch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lch</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span> <span class="n">rounding</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">2</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">ColorRecord</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Find color by LCH match (with rounding for fuzzy matching).&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_by_lch</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">_rounded_key</span><span class="p">(</span><span class="n">lch</span><span class="p">,</span> <span class="n">rounding</span><span class="p">))</span></div>


<div class="viewcode-block" id="Palette.nearest_color">
<a class="viewcode-back" href="../../api/color_tools.palette.html#color_tools.palette.Palette.nearest_color">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">nearest_color</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">value</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span>
        <span class="n">space</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;lab&quot;</span><span class="p">,</span>
        <span class="n">metric</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;de2000&quot;</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">cmc_l</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">ColorConstants</span><span class="o">.</span><span class="n">CMC_L_DEFAULT</span><span class="p">,</span>
        <span class="n">cmc_c</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">ColorConstants</span><span class="o">.</span><span class="n">CMC_C_DEFAULT</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">ColorRecord</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Find nearest color by space/metric.</span>
<span class="sd">        </span>
<span class="sd">        This is the main search function! It iterates through all colors</span>
<span class="sd">        and finds the one with minimum distance in the specified space.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            value: Color in the specified space (RGB, HSL, LAB, or LCH)</span>
<span class="sd">            space: Color space - &#39;rgb&#39;, &#39;hsl&#39;, &#39;lab&#39;, or &#39;lch&#39; (default: &#39;lab&#39;)</span>
<span class="sd">            metric: Distance metric - &#39;euclidean&#39;, &#39;de76&#39;, &#39;de94&#39;, &#39;de2000&#39;, &#39;cmc&#39;</span>
<span class="sd">            cmc_l, cmc_c: Parameters for CMC metric (default 2:1 for acceptability)</span>
<span class="sd">        </span>
<span class="sd">        Returns:</span>
<span class="sd">            (nearest_color_record, distance) tuple</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">best_rec</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">ColorRecord</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">best_d</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s2">&quot;inf&quot;</span><span class="p">)</span>

        <span class="c1"># RGB space - use simple Euclidean distance</span>
        <span class="k">if</span> <span class="n">space</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;rgb&quot;</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">records</span><span class="p">:</span>
                <span class="n">d</span> <span class="o">=</span> <span class="n">euclidean</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="n">value</span><span class="p">)),</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">rgb</span><span class="p">)))</span>
                <span class="k">if</span> <span class="n">d</span> <span class="o">&lt;</span> <span class="n">best_d</span> <span class="ow">or</span> <span class="p">(</span><span class="n">d</span> <span class="o">==</span> <span class="n">best_d</span> <span class="ow">and</span> <span class="n">best_rec</span> <span class="ow">and</span> <span class="n">_should_prefer_source</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">source</span><span class="p">,</span> <span class="n">best_rec</span><span class="o">.</span><span class="n">source</span><span class="p">)):</span>
                    <span class="n">best_rec</span><span class="p">,</span> <span class="n">best_d</span> <span class="o">=</span> <span class="n">r</span><span class="p">,</span> <span class="n">d</span>
            <span class="k">return</span> <span class="n">best_rec</span><span class="p">,</span> <span class="n">best_d</span>  <span class="c1"># type: ignore</span>

        <span class="c1"># HSL space - use circular hue distance</span>
        <span class="k">if</span> <span class="n">space</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;hsl&quot;</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">records</span><span class="p">:</span>
                <span class="n">d</span> <span class="o">=</span> <span class="n">hsl_euclidean</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">hsl</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">d</span> <span class="o">&lt;</span> <span class="n">best_d</span> <span class="ow">or</span> <span class="p">(</span><span class="n">d</span> <span class="o">==</span> <span class="n">best_d</span> <span class="ow">and</span> <span class="n">best_rec</span> <span class="ow">and</span> <span class="n">_should_prefer_source</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">source</span><span class="p">,</span> <span class="n">best_rec</span><span class="o">.</span><span class="n">source</span><span class="p">)):</span>
                    <span class="n">best_rec</span><span class="p">,</span> <span class="n">best_d</span> <span class="o">=</span> <span class="n">r</span><span class="p">,</span> <span class="n">d</span>
            <span class="k">return</span> <span class="n">best_rec</span><span class="p">,</span> <span class="n">best_d</span>  <span class="c1"># type: ignore</span>

        <span class="c1"># LCH space - use Euclidean distance with hue wraparound</span>
        <span class="k">if</span> <span class="n">space</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;lch&quot;</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">records</span><span class="p">:</span>
                <span class="c1"># LCH has circular hue like HSL, so we need special handling</span>
                <span class="n">d</span> <span class="o">=</span> <span class="n">hsl_euclidean</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">lch</span><span class="p">)</span>  <span class="c1"># hsl_euclidean handles circular hue properly</span>
                <span class="k">if</span> <span class="n">d</span> <span class="o">&lt;</span> <span class="n">best_d</span> <span class="ow">or</span> <span class="p">(</span><span class="n">d</span> <span class="o">==</span> <span class="n">best_d</span> <span class="ow">and</span> <span class="n">best_rec</span> <span class="ow">and</span> <span class="n">_should_prefer_source</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">source</span><span class="p">,</span> <span class="n">best_rec</span><span class="o">.</span><span class="n">source</span><span class="p">)):</span>
                    <span class="n">best_rec</span><span class="p">,</span> <span class="n">best_d</span> <span class="o">=</span> <span class="n">r</span><span class="p">,</span> <span class="n">d</span>
            <span class="k">return</span> <span class="n">best_rec</span><span class="p">,</span> <span class="n">best_d</span>  <span class="c1"># type: ignore</span>

        <span class="c1"># LAB space - choose the appropriate Delta E metric</span>
        <span class="n">metric_l</span> <span class="o">=</span> <span class="n">metric</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">metric_l</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;de2000&quot;</span><span class="p">,</span> <span class="s2">&quot;ciede2000&quot;</span><span class="p">):</span>
            <span class="n">fn</span> <span class="o">=</span> <span class="n">delta_e_2000</span>
        <span class="k">elif</span> <span class="n">metric_l</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;de94&quot;</span><span class="p">,</span> <span class="s2">&quot;cie94&quot;</span><span class="p">):</span>
            <span class="n">fn</span> <span class="o">=</span> <span class="n">delta_e_94</span>
        <span class="k">elif</span> <span class="n">metric_l</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;de76&quot;</span><span class="p">,</span> <span class="s2">&quot;cie76&quot;</span><span class="p">,</span> <span class="s2">&quot;euclidean&quot;</span><span class="p">):</span>
            <span class="n">fn</span> <span class="o">=</span> <span class="n">delta_e_76</span>
        <span class="k">elif</span> <span class="n">metric_l</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;cmc&quot;</span><span class="p">,</span> <span class="s2">&quot;decmc&quot;</span><span class="p">,</span> <span class="s2">&quot;cmc21&quot;</span><span class="p">,</span> <span class="s2">&quot;cmc11&quot;</span><span class="p">):</span>
            <span class="c1"># CMC has special handling for l:c ratios</span>
            <span class="n">fn</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Will handle specially below</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Unknown metric. Use &#39;euclidean&#39;/&#39;de76&#39;/&#39;de94&#39;/&#39;de2000&#39;/&#39;cmc&#39;.&quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">records</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">metric_l</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;cmc&quot;</span><span class="p">,</span> <span class="s2">&quot;decmc&quot;</span><span class="p">,</span> <span class="s2">&quot;cmc21&quot;</span><span class="p">,</span> <span class="s2">&quot;cmc11&quot;</span><span class="p">):</span>
                <span class="c1"># Allow shorthands</span>
                <span class="n">l</span><span class="p">,</span> <span class="n">c</span> <span class="o">=</span> <span class="n">cmc_l</span><span class="p">,</span> <span class="n">cmc_c</span>
                <span class="k">if</span> <span class="n">metric_l</span> <span class="o">==</span> <span class="s2">&quot;cmc21&quot;</span><span class="p">:</span>
                    <span class="n">l</span><span class="p">,</span> <span class="n">c</span> <span class="o">=</span> <span class="n">ColorConstants</span><span class="o">.</span><span class="n">CMC_L_DEFAULT</span><span class="p">,</span> <span class="n">ColorConstants</span><span class="o">.</span><span class="n">CMC_C_DEFAULT</span>
                <span class="k">elif</span> <span class="n">metric_l</span> <span class="o">==</span> <span class="s2">&quot;cmc11&quot;</span><span class="p">:</span>
                    <span class="n">l</span><span class="p">,</span> <span class="n">c</span> <span class="o">=</span> <span class="n">ColorConstants</span><span class="o">.</span><span class="n">CMC_C_DEFAULT</span><span class="p">,</span> <span class="n">ColorConstants</span><span class="o">.</span><span class="n">CMC_C_DEFAULT</span>
                <span class="n">d</span> <span class="o">=</span> <span class="n">delta_e_cmc</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">lab</span><span class="p">,</span> <span class="n">l</span><span class="o">=</span><span class="n">l</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">c</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">d</span> <span class="o">=</span> <span class="n">fn</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">lab</span><span class="p">)</span>  <span class="c1"># type: ignore</span>
            <span class="k">if</span> <span class="n">d</span> <span class="o">&lt;</span> <span class="n">best_d</span> <span class="ow">or</span> <span class="p">(</span><span class="n">d</span> <span class="o">==</span> <span class="n">best_d</span> <span class="ow">and</span> <span class="n">best_rec</span> <span class="ow">and</span> <span class="n">_should_prefer_source</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">source</span><span class="p">,</span> <span class="n">best_rec</span><span class="o">.</span><span class="n">source</span><span class="p">)):</span>
                <span class="n">best_rec</span><span class="p">,</span> <span class="n">best_d</span> <span class="o">=</span> <span class="n">r</span><span class="p">,</span> <span class="n">d</span>
        <span class="k">return</span> <span class="n">best_rec</span><span class="p">,</span> <span class="n">best_d</span>  <span class="c1"># type: ignore</span></div>


<div class="viewcode-block" id="Palette.nearest_colors">
<a class="viewcode-back" href="../../api/color_tools.palette.html#color_tools.palette.Palette.nearest_colors">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">nearest_colors</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">value</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span>
        <span class="n">space</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;lab&quot;</span><span class="p">,</span>
        <span class="n">metric</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;de2000&quot;</span><span class="p">,</span>
        <span class="n">count</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">cmc_l</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">ColorConstants</span><span class="o">.</span><span class="n">CMC_L_DEFAULT</span><span class="p">,</span>
        <span class="n">cmc_c</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">ColorConstants</span><span class="o">.</span><span class="n">CMC_C_DEFAULT</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">ColorRecord</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Find the nearest N colors by space/metric.</span>
<span class="sd">        </span>
<span class="sd">        Similar to nearest_color but returns multiple results sorted by distance.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            value: Color in the specified space (RGB, HSL, LAB, or LCH)</span>
<span class="sd">            space: Color space - &#39;rgb&#39;, &#39;hsl&#39;, &#39;lab&#39;, or &#39;lch&#39; (default: &#39;lab&#39;)</span>
<span class="sd">            metric: Distance metric - &#39;euclidean&#39;, &#39;de76&#39;, &#39;de94&#39;, &#39;de2000&#39;, &#39;cmc&#39;</span>
<span class="sd">            count: Number of results to return (default: 5, max: 50)</span>
<span class="sd">            cmc_l, cmc_c: Parameters for CMC metric (default 2:1 for acceptability)</span>
<span class="sd">        </span>
<span class="sd">        Returns:</span>
<span class="sd">            List of (color_record, distance) tuples sorted by distance (closest first)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Limit count to reasonable maximum</span>
        <span class="n">count</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">count</span><span class="p">,</span> <span class="mi">50</span><span class="p">)</span>
        <span class="n">count</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">count</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        
        <span class="n">results</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">ColorRecord</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># RGB space - use simple Euclidean distance</span>
        <span class="k">if</span> <span class="n">space</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;rgb&quot;</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">records</span><span class="p">:</span>
                <span class="n">d</span> <span class="o">=</span> <span class="n">euclidean</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="n">value</span><span class="p">)),</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">rgb</span><span class="p">)))</span>
                <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">r</span><span class="p">,</span> <span class="n">d</span><span class="p">))</span>
            <span class="n">results</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">return</span> <span class="n">results</span><span class="p">[:</span><span class="n">count</span><span class="p">]</span>

        <span class="c1"># HSL space - use circular hue distance</span>
        <span class="k">if</span> <span class="n">space</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;hsl&quot;</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">records</span><span class="p">:</span>
                <span class="n">d</span> <span class="o">=</span> <span class="n">hsl_euclidean</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">hsl</span><span class="p">)</span>
                <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">r</span><span class="p">,</span> <span class="n">d</span><span class="p">))</span>
            <span class="n">results</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">return</span> <span class="n">results</span><span class="p">[:</span><span class="n">count</span><span class="p">]</span>

        <span class="c1"># LCH space - use Euclidean distance with hue wraparound</span>
        <span class="k">if</span> <span class="n">space</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;lch&quot;</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">records</span><span class="p">:</span>
                <span class="n">d</span> <span class="o">=</span> <span class="n">hsl_euclidean</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">lch</span><span class="p">)</span>  <span class="c1"># hsl_euclidean handles circular hue properly</span>
                <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">r</span><span class="p">,</span> <span class="n">d</span><span class="p">))</span>
            <span class="n">results</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">return</span> <span class="n">results</span><span class="p">[:</span><span class="n">count</span><span class="p">]</span>

        <span class="c1"># LAB space - choose the appropriate Delta E metric</span>
        <span class="n">metric_l</span> <span class="o">=</span> <span class="n">metric</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">metric_l</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;de2000&quot;</span><span class="p">,</span> <span class="s2">&quot;ciede2000&quot;</span><span class="p">):</span>
            <span class="n">fn</span> <span class="o">=</span> <span class="n">delta_e_2000</span>
        <span class="k">elif</span> <span class="n">metric_l</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;de94&quot;</span><span class="p">,</span> <span class="s2">&quot;cie94&quot;</span><span class="p">):</span>
            <span class="n">fn</span> <span class="o">=</span> <span class="n">delta_e_94</span>
        <span class="k">elif</span> <span class="n">metric_l</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;de76&quot;</span><span class="p">,</span> <span class="s2">&quot;cie76&quot;</span><span class="p">,</span> <span class="s2">&quot;euclidean&quot;</span><span class="p">):</span>
            <span class="n">fn</span> <span class="o">=</span> <span class="n">delta_e_76</span>
        <span class="k">elif</span> <span class="n">metric_l</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;cmc&quot;</span><span class="p">,</span> <span class="s2">&quot;decmc&quot;</span><span class="p">,</span> <span class="s2">&quot;cmc21&quot;</span><span class="p">,</span> <span class="s2">&quot;cmc11&quot;</span><span class="p">):</span>
            <span class="c1"># CMC has special handling for l:c ratios</span>
            <span class="n">fn</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Will handle specially below</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Unknown metric. Use &#39;euclidean&#39;/&#39;de76&#39;/&#39;de94&#39;/&#39;de2000&#39;/&#39;cmc&#39;.&quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">records</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">metric_l</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;cmc&quot;</span><span class="p">,</span> <span class="s2">&quot;decmc&quot;</span><span class="p">,</span> <span class="s2">&quot;cmc21&quot;</span><span class="p">,</span> <span class="s2">&quot;cmc11&quot;</span><span class="p">):</span>
                <span class="c1"># Allow shorthands</span>
                <span class="n">l</span><span class="p">,</span> <span class="n">c</span> <span class="o">=</span> <span class="n">cmc_l</span><span class="p">,</span> <span class="n">cmc_c</span>
                <span class="k">if</span> <span class="n">metric_l</span> <span class="o">==</span> <span class="s2">&quot;cmc21&quot;</span><span class="p">:</span>
                    <span class="n">l</span><span class="p">,</span> <span class="n">c</span> <span class="o">=</span> <span class="n">ColorConstants</span><span class="o">.</span><span class="n">CMC_L_DEFAULT</span><span class="p">,</span> <span class="n">ColorConstants</span><span class="o">.</span><span class="n">CMC_C_DEFAULT</span>
                <span class="k">elif</span> <span class="n">metric_l</span> <span class="o">==</span> <span class="s2">&quot;cmc11&quot;</span><span class="p">:</span>
                    <span class="n">l</span><span class="p">,</span> <span class="n">c</span> <span class="o">=</span> <span class="n">ColorConstants</span><span class="o">.</span><span class="n">CMC_C_DEFAULT</span><span class="p">,</span> <span class="n">ColorConstants</span><span class="o">.</span><span class="n">CMC_C_DEFAULT</span>
                <span class="n">d</span> <span class="o">=</span> <span class="n">delta_e_cmc</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">lab</span><span class="p">,</span> <span class="n">l</span><span class="o">=</span><span class="n">l</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">c</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">d</span> <span class="o">=</span> <span class="n">fn</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">lab</span><span class="p">)</span>  <span class="c1"># type: ignore</span>
            <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">r</span><span class="p">,</span> <span class="n">d</span><span class="p">))</span>
        
        <span class="n">results</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">results</span><span class="p">[:</span><span class="n">count</span><span class="p">]</span></div>


<div class="viewcode-block" id="Palette.get_override_info">
<a class="viewcode-back" href="../../api/color_tools.palette.html#color_tools.palette.Palette.get_override_info">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_override_info</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get information about user overrides in this palette.</span>
<span class="sd">        </span>
<span class="sd">        Returns:</span>
<span class="sd">            Dictionary with override information structure:</span>
<span class="sd">            </span>
<span class="sd">            .. code-block:: python</span>
<span class="sd">            </span>
<span class="sd">                {</span>
<span class="sd">                    &quot;colors&quot;: {</span>
<span class="sd">                        &quot;name&quot;: {&quot;color_name&quot;: (&quot;core_source&quot;, &quot;user_source&quot;)},</span>
<span class="sd">                        &quot;rgb&quot;: {&quot;(r,g,b)&quot;: (&quot;core_source&quot;, &quot;user_source&quot;)}</span>
<span class="sd">                    }</span>
<span class="sd">                }</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">overrides</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]]]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;colors&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="p">{},</span> <span class="s2">&quot;rgb&quot;</span><span class="p">:</span> <span class="p">{}}</span>
        <span class="p">}</span>
        
        <span class="c1"># Group records by name and RGB to detect overrides</span>
        <span class="n">name_groups</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">ColorRecord</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">rgb_groups</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span> <span class="n">List</span><span class="p">[</span><span class="n">ColorRecord</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>
        
        <span class="k">for</span> <span class="n">record</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">records</span><span class="p">:</span>
            <span class="n">name_key</span> <span class="o">=</span> <span class="n">record</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">name_key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">name_groups</span><span class="p">:</span>
                <span class="n">name_groups</span><span class="p">[</span><span class="n">name_key</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">name_groups</span><span class="p">[</span><span class="n">name_key</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">record</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="n">record</span><span class="o">.</span><span class="n">rgb</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">rgb_groups</span><span class="p">:</span>
                <span class="n">rgb_groups</span><span class="p">[</span><span class="n">record</span><span class="o">.</span><span class="n">rgb</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">rgb_groups</span><span class="p">[</span><span class="n">record</span><span class="o">.</span><span class="n">rgb</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">record</span><span class="p">)</span>
        
        <span class="c1"># Check for name overrides</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">records</span> <span class="ow">in</span> <span class="n">name_groups</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">records</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="c1"># Multiple records with same name - find override pattern</span>
                <span class="n">core_records</span> <span class="o">=</span> <span class="p">[</span><span class="n">r</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">records</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">r</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;user-&#39;</span><span class="p">)]</span>
                <span class="n">user_records</span> <span class="o">=</span> <span class="p">[</span><span class="n">r</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">records</span> <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;user-&#39;</span><span class="p">)]</span>
                <span class="k">if</span> <span class="n">core_records</span> <span class="ow">and</span> <span class="n">user_records</span><span class="p">:</span>
                    <span class="n">overrides</span><span class="p">[</span><span class="s2">&quot;colors&quot;</span><span class="p">][</span><span class="s2">&quot;name&quot;</span><span class="p">][</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">core_records</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">source</span><span class="p">,</span> <span class="n">user_records</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">source</span><span class="p">)</span>
        
        <span class="c1"># Check for RGB overrides  </span>
        <span class="k">for</span> <span class="n">rgb</span><span class="p">,</span> <span class="n">records</span> <span class="ow">in</span> <span class="n">rgb_groups</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">records</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="c1"># Multiple records with same RGB - find override pattern</span>
                <span class="n">core_records</span> <span class="o">=</span> <span class="p">[</span><span class="n">r</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">records</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">r</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;user-&#39;</span><span class="p">)]</span>
                <span class="n">user_records</span> <span class="o">=</span> <span class="p">[</span><span class="n">r</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">records</span> <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;user-&#39;</span><span class="p">)]</span>
                <span class="k">if</span> <span class="n">core_records</span> <span class="ow">and</span> <span class="n">user_records</span><span class="p">:</span>
                    <span class="n">overrides</span><span class="p">[</span><span class="s2">&quot;colors&quot;</span><span class="p">][</span><span class="s2">&quot;rgb&quot;</span><span class="p">][</span><span class="nb">str</span><span class="p">(</span><span class="n">rgb</span><span class="p">)]</span> <span class="o">=</span> <span class="p">(</span><span class="n">core_records</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">source</span><span class="p">,</span> <span class="n">user_records</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">source</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">overrides</span></div>
</div>



<div class="viewcode-block" id="FilamentPalette">
<a class="viewcode-back" href="../../api/color_tools.palette.html#color_tools.palette.FilamentPalette">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">FilamentPalette</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Filament palette with multiple indexing strategies for fast lookup.</span>
<span class="sd">    </span>
<span class="sd">    Similar to Palette, but designed for 3D printing filaments which have</span>
<span class="sd">    additional properties (maker, type, finish) that we want to search by.</span>
<span class="sd">    </span>
<span class="sd">    The indices allow for fast filtering: &quot;Show me all Bambu Lab PLA Matte filaments&quot;</span>
<span class="sd">    becomes a simple dictionary lookup instead of scanning the whole list! ðŸ“‡</span>
<span class="sd">    </span>
<span class="sd">    Supports maker synonyms: you can search for &quot;Bambu&quot; and it will find &quot;Bambu Lab&quot;</span>
<span class="sd">    filaments automatically.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
<div class="viewcode-block" id="FilamentPalette.__init__">
<a class="viewcode-back" href="../../api/color_tools.palette.html#color_tools.palette.FilamentPalette.__init__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">records</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">FilamentRecord</span><span class="p">],</span> <span class="n">maker_synonyms</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">records</span> <span class="o">=</span> <span class="n">records</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">maker_synonyms</span> <span class="o">=</span> <span class="n">maker_synonyms</span> <span class="ow">or</span> <span class="p">{}</span>
        
        <span class="c1"># Create various lookup indices (note: Lists, not single items!)</span>
        <span class="c1"># Multiple filaments can share the same maker/type/color</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_by_maker</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">FilamentRecord</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_by_type</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">FilamentRecord</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_by_color</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">FilamentRecord</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_by_rgb</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span> <span class="n">List</span><span class="p">[</span><span class="n">FilamentRecord</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_by_finish</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">FilamentRecord</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>
        
        <span class="c1"># Build indices</span>
        <span class="k">for</span> <span class="n">rec</span> <span class="ow">in</span> <span class="n">records</span><span class="p">:</span>
            <span class="c1"># By maker</span>
            <span class="k">if</span> <span class="n">rec</span><span class="o">.</span><span class="n">maker</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_by_maker</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_by_maker</span><span class="p">[</span><span class="n">rec</span><span class="o">.</span><span class="n">maker</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_by_maker</span><span class="p">[</span><span class="n">rec</span><span class="o">.</span><span class="n">maker</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rec</span><span class="p">)</span>
            
            <span class="c1"># By type</span>
            <span class="k">if</span> <span class="n">rec</span><span class="o">.</span><span class="n">type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_by_type</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_by_type</span><span class="p">[</span><span class="n">rec</span><span class="o">.</span><span class="n">type</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_by_type</span><span class="p">[</span><span class="n">rec</span><span class="o">.</span><span class="n">type</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rec</span><span class="p">)</span>
            
            <span class="c1"># By color (case-insensitive)</span>
            <span class="n">color_key</span> <span class="o">=</span> <span class="n">rec</span><span class="o">.</span><span class="n">color</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">color_key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_by_color</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_by_color</span><span class="p">[</span><span class="n">color_key</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_by_color</span><span class="p">[</span><span class="n">color_key</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rec</span><span class="p">)</span>
            
            <span class="c1"># By RGB</span>
            <span class="n">rgb</span> <span class="o">=</span> <span class="n">rec</span><span class="o">.</span><span class="n">rgb</span>
            <span class="k">if</span> <span class="n">rgb</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_by_rgb</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_by_rgb</span><span class="p">[</span><span class="n">rgb</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_by_rgb</span><span class="p">[</span><span class="n">rgb</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rec</span><span class="p">)</span>
            
            <span class="c1"># By finish (if present)</span>
            <span class="k">if</span> <span class="n">rec</span><span class="o">.</span><span class="n">finish</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">rec</span><span class="o">.</span><span class="n">finish</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_by_finish</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_by_finish</span><span class="p">[</span><span class="n">rec</span><span class="o">.</span><span class="n">finish</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_by_finish</span><span class="p">[</span><span class="n">rec</span><span class="o">.</span><span class="n">finish</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rec</span><span class="p">)</span></div>

    
    <span class="k">def</span><span class="w"> </span><span class="nf">_expand_maker_names</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">makers</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Set</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Expand maker names to include synonyms.</span>
<span class="sd">        </span>
<span class="sd">        For example, if &quot;Bambu&quot; is provided and &quot;Bambu Lab&quot; has synonyms [&quot;Bambu&quot;, &quot;BLL&quot;],</span>
<span class="sd">        this will return {&quot;Bambu Lab&quot;, &quot;Bambu&quot;, &quot;BLL&quot;}.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            makers: List of maker names or synonyms to expand</span>
<span class="sd">        </span>
<span class="sd">        Returns:</span>
<span class="sd">            Set of all canonical names and synonyms that match</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">expanded</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">maker</span> <span class="ow">in</span> <span class="n">makers</span><span class="p">:</span>
            <span class="c1"># Add the original name</span>
            <span class="n">expanded</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">maker</span><span class="p">)</span>
            
            <span class="c1"># Check if this maker IS a canonical name</span>
            <span class="k">if</span> <span class="n">maker</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">maker_synonyms</span><span class="p">:</span>
                <span class="n">expanded</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">maker_synonyms</span><span class="p">[</span><span class="n">maker</span><span class="p">])</span>
            
            <span class="c1"># Check if this maker is a synonym for a canonical name</span>
            <span class="k">for</span> <span class="n">canonical</span><span class="p">,</span> <span class="n">synonyms</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">maker_synonyms</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">maker</span> <span class="ow">in</span> <span class="n">synonyms</span><span class="p">:</span>
                    <span class="n">expanded</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">canonical</span><span class="p">)</span>
                    <span class="n">expanded</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">synonyms</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">expanded</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">_normalize_filter_values</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]])</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Set</span><span class="p">[</span><span class="nb">str</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Convert a filter value (str or list) to a set for fast lookups.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            value: A string, a list of strings, or None.</span>
<span class="sd">            </span>
<span class="sd">        Returns:</span>
<span class="sd">            A set of strings, or None if the input was None.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">{</span><span class="n">value</span><span class="p">}</span>
        <span class="k">return</span> <span class="nb">set</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

<div class="viewcode-block" id="FilamentPalette.load_default">
<a class="viewcode-back" href="../../api/color_tools.palette.html#color_tools.palette.FilamentPalette.load_default">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">load_default</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;FilamentPalette&#39;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Load the default filament palette from the package data.</span>
<span class="sd">        </span>
<span class="sd">        Convenience method for quick loading without worrying about paths.</span>
<span class="sd">        Also loads maker synonyms automatically.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">load_filaments</span><span class="p">(),</span> <span class="n">load_maker_synonyms</span><span class="p">())</span></div>


<div class="viewcode-block" id="FilamentPalette.find_by_maker">
<a class="viewcode-back" href="../../api/color_tools.palette.html#color_tools.palette.FilamentPalette.find_by_maker">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">find_by_maker</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">maker</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">FilamentRecord</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Find all filaments by a single maker or a list of makers.</span>
<span class="sd">        </span>
<span class="sd">        Supports synonyms: searching for &quot;Bambu&quot; will find &quot;Bambu Lab&quot; filaments.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            maker: A single maker name (str) or a list of names (can use synonyms).</span>
<span class="sd">            </span>
<span class="sd">        Returns:</span>
<span class="sd">            A list of all matching FilamentRecord objects.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">makers_to_find</span> <span class="o">=</span> <span class="n">_ensure_list</span><span class="p">(</span><span class="n">maker</span><span class="p">)</span>
        <span class="n">expanded_makers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_expand_maker_names</span><span class="p">(</span><span class="n">makers_to_find</span><span class="p">)</span>
        
        <span class="n">all_filaments</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">expanded_makers</span><span class="p">:</span>
            <span class="n">all_filaments</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_by_maker</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="p">[]))</span>
        
        <span class="c1"># Remove duplicates while preserving order</span>
        <span class="n">seen</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="n">unique_filaments</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">filament</span> <span class="ow">in</span> <span class="n">all_filaments</span><span class="p">:</span>
            <span class="n">filament_id</span> <span class="o">=</span> <span class="nb">id</span><span class="p">(</span><span class="n">filament</span><span class="p">)</span>  <span class="c1"># Use object identity</span>
            <span class="k">if</span> <span class="n">filament_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">seen</span><span class="p">:</span>
                <span class="n">seen</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">filament_id</span><span class="p">)</span>
                <span class="n">unique_filaments</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">filament</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">unique_filaments</span></div>


<div class="viewcode-block" id="FilamentPalette.find_by_type">
<a class="viewcode-back" href="../../api/color_tools.palette.html#color_tools.palette.FilamentPalette.find_by_type">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">find_by_type</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">type_name</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">FilamentRecord</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Find all filaments by a single type or a list of types.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            type_name: A single filament type (str) or a list of types.</span>
<span class="sd">            </span>
<span class="sd">        Returns:</span>
<span class="sd">            A list of all matching FilamentRecord objects.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">types_to_find</span> <span class="o">=</span> <span class="n">_ensure_list</span><span class="p">(</span><span class="n">type_name</span><span class="p">)</span>

        <span class="n">all_filaments</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">types_to_find</span><span class="p">:</span>
            <span class="n">all_filaments</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_by_type</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="p">[]))</span>
        <span class="k">return</span> <span class="n">all_filaments</span></div>


<div class="viewcode-block" id="FilamentPalette.find_by_color">
<a class="viewcode-back" href="../../api/color_tools.palette.html#color_tools.palette.FilamentPalette.find_by_color">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">find_by_color</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">color</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">FilamentRecord</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Find all filaments by color name (case-insensitive).&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_by_color</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">color</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span> <span class="p">[])</span></div>


<div class="viewcode-block" id="FilamentPalette.find_by_rgb">
<a class="viewcode-back" href="../../api/color_tools.palette.html#color_tools.palette.FilamentPalette.find_by_rgb">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">find_by_rgb</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rgb</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">FilamentRecord</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Find all filaments by exact RGB match, with user filaments prioritized.&quot;&quot;&quot;</span>
        <span class="n">matches</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_by_rgb</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">rgb</span><span class="p">,</span> <span class="p">[])</span>
        <span class="c1"># Sort to prioritize user sources over core sources</span>
        <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">matches</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">r</span><span class="p">:</span> <span class="p">(</span><span class="ow">not</span> <span class="n">r</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;user-&#39;</span><span class="p">),</span> <span class="n">r</span><span class="o">.</span><span class="n">maker</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">color</span><span class="p">))</span></div>


<div class="viewcode-block" id="FilamentPalette.find_by_finish">
<a class="viewcode-back" href="../../api/color_tools.palette.html#color_tools.palette.FilamentPalette.find_by_finish">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">find_by_finish</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">finish</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">FilamentRecord</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Find all filaments by a single finish or a list of finishes.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            finish: A single filament finish (str) or a list of finishes.</span>
<span class="sd">            </span>
<span class="sd">        Returns:</span>
<span class="sd">            A list of all matching FilamentRecord objects.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">finishes_to_find</span> <span class="o">=</span> <span class="n">_ensure_list</span><span class="p">(</span><span class="n">finish</span><span class="p">)</span>
            
        <span class="n">all_filaments</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">finishes_to_find</span><span class="p">:</span>
            <span class="n">all_filaments</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_by_finish</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="p">[]))</span>
        <span class="k">return</span> <span class="n">all_filaments</span></div>


<div class="viewcode-block" id="FilamentPalette.filter">
<a class="viewcode-back" href="../../api/color_tools.palette.html#color_tools.palette.FilamentPalette.filter">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">filter</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">maker</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">type_name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">finish</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">color</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">FilamentRecord</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Filter filaments by multiple criteria.</span>
<span class="sd">        </span>
<span class="sd">        This is like SQL WHERE clauses! Start with all records, then filter</span>
<span class="sd">        down by each criterion that&#39;s provided. Maker, type, and finish</span>
<span class="sd">        can accept a single string or a list of strings.</span>
<span class="sd">        </span>
<span class="sd">        Supports maker synonyms: filtering by &quot;Bambu&quot; will include &quot;Bambu Lab&quot;.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            maker: A maker name or list of maker names (can use synonyms).</span>
<span class="sd">            type_name: A filament type or list of types.</span>
<span class="sd">            finish: A filament finish or list of finishes.</span>
<span class="sd">            color: A single color name to match (case-insensitive).</span>
<span class="sd">        </span>
<span class="sd">        Returns:</span>
<span class="sd">            A list of FilamentRecord objects matching the criteria.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">records</span>
        
        <span class="n">makers_set</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_normalize_filter_values</span><span class="p">(</span><span class="n">maker</span><span class="p">)</span>
        <span class="n">types_set</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_normalize_filter_values</span><span class="p">(</span><span class="n">type_name</span><span class="p">)</span>
        <span class="n">finishes_set</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_normalize_filter_values</span><span class="p">(</span><span class="n">finish</span><span class="p">)</span>
        
        <span class="c1"># Expand maker names to include synonyms</span>
        <span class="k">if</span> <span class="n">makers_set</span><span class="p">:</span>
            <span class="n">makers_set</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_expand_maker_names</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">makers_set</span><span class="p">))</span>
        
        <span class="k">if</span> <span class="n">makers_set</span><span class="p">:</span>
            <span class="n">results</span> <span class="o">=</span> <span class="p">[</span><span class="n">r</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">results</span> <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">maker</span> <span class="ow">in</span> <span class="n">makers_set</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">types_set</span><span class="p">:</span>
            <span class="n">results</span> <span class="o">=</span> <span class="p">[</span><span class="n">r</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">results</span> <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">type</span> <span class="ow">in</span> <span class="n">types_set</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">finishes_set</span><span class="p">:</span>
            <span class="n">results</span> <span class="o">=</span> <span class="p">[</span><span class="n">r</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">results</span> <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">finish</span> <span class="ow">and</span> <span class="n">r</span><span class="o">.</span><span class="n">finish</span> <span class="ow">in</span> <span class="n">finishes_set</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">color</span><span class="p">:</span>
            <span class="n">results</span> <span class="o">=</span> <span class="p">[</span><span class="n">r</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">results</span> <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">color</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="n">color</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span>
            
        <span class="k">return</span> <span class="n">results</span></div>


<div class="viewcode-block" id="FilamentPalette.nearest_filament">
<a class="viewcode-back" href="../../api/color_tools.palette.html#color_tools.palette.FilamentPalette.nearest_filament">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">nearest_filament</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">target_rgb</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span>
        <span class="n">metric</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;de2000&quot;</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">maker</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">type_name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">finish</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">cmc_l</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">ColorConstants</span><span class="o">.</span><span class="n">CMC_L_DEFAULT</span><span class="p">,</span>
        <span class="n">cmc_c</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">ColorConstants</span><span class="o">.</span><span class="n">CMC_C_DEFAULT</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">FilamentRecord</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Find nearest filament by color similarity, with optional filters.</span>
<span class="sd">        </span>
<span class="sd">        The killer feature for 3D printing! &quot;I want this exact color... what</span>
<span class="sd">        filament should I buy?&quot; ðŸŽ¨ðŸ–¨ï¸</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            target_rgb: Target RGB color tuple.</span>
<span class="sd">            metric: Distance metric - &#39;euclidean&#39;, &#39;de76&#39;, &#39;de94&#39;, &#39;de2000&#39;, &#39;cmc&#39;.</span>
<span class="sd">            maker: Optional maker name or list of names to filter by. Use &quot;*&quot; to ignore filter.</span>
<span class="sd">            type_name: Optional filament type or list of types to filter by. Use &quot;*&quot; to ignore filter.</span>
<span class="sd">            finish: Optional filament finish or list of finishes to filter by. Use &quot;*&quot; to ignore filter.</span>
<span class="sd">            cmc_l, cmc_c: Parameters for CMC metric.</span>
<span class="sd">        </span>
<span class="sd">        Returns:</span>
<span class="sd">            (nearest_filament_record, distance) tuple.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">target_lab</span> <span class="o">=</span> <span class="n">rgb_to_lab</span><span class="p">(</span><span class="n">target_rgb</span><span class="p">)</span>
        
        <span class="c1"># Handle &quot;*&quot; wildcard filters (ignore filter if &quot;*&quot; is passed)</span>
        <span class="n">maker_filter</span> <span class="o">=</span> <span class="kc">None</span> <span class="k">if</span> <span class="n">maker</span> <span class="o">==</span> <span class="s2">&quot;*&quot;</span> <span class="k">else</span> <span class="n">maker</span>
        <span class="n">type_filter</span> <span class="o">=</span> <span class="kc">None</span> <span class="k">if</span> <span class="n">type_name</span> <span class="o">==</span> <span class="s2">&quot;*&quot;</span> <span class="k">else</span> <span class="n">type_name</span>
        <span class="n">finish_filter</span> <span class="o">=</span> <span class="kc">None</span> <span class="k">if</span> <span class="n">finish</span> <span class="o">==</span> <span class="s2">&quot;*&quot;</span> <span class="k">else</span> <span class="n">finish</span>
        
        <span class="c1"># Apply filters by calling our powerful filter() method first!</span>
        <span class="n">candidates</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">maker</span><span class="o">=</span><span class="n">maker_filter</span><span class="p">,</span> <span class="n">type_name</span><span class="o">=</span><span class="n">type_filter</span><span class="p">,</span> <span class="n">finish</span><span class="o">=</span><span class="n">finish_filter</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">candidates</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No filaments match the specified filters&quot;</span><span class="p">)</span>
        
        <span class="n">best_rec</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">FilamentRecord</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">best_d</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s2">&quot;inf&quot;</span><span class="p">)</span>

        <span class="c1"># Choose distance function</span>
        <span class="n">metric_l</span> <span class="o">=</span> <span class="n">metric</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">metric_l</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;de2000&quot;</span><span class="p">,</span> <span class="s2">&quot;ciede2000&quot;</span><span class="p">):</span>
            <span class="n">distance_fn</span> <span class="o">=</span> <span class="n">delta_e_2000</span>
        <span class="k">elif</span> <span class="n">metric_l</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;de94&quot;</span><span class="p">,</span> <span class="s2">&quot;cie94&quot;</span><span class="p">):</span>
            <span class="n">distance_fn</span> <span class="o">=</span> <span class="n">delta_e_94</span>
        <span class="k">elif</span> <span class="n">metric_l</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;de76&quot;</span><span class="p">,</span> <span class="s2">&quot;cie76&quot;</span><span class="p">):</span>
            <span class="n">distance_fn</span> <span class="o">=</span> <span class="n">delta_e_76</span>
        <span class="k">elif</span> <span class="n">metric_l</span> <span class="o">==</span> <span class="s2">&quot;euclidean&quot;</span><span class="p">:</span>
            <span class="n">distance_fn</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">lab1</span><span class="p">,</span> <span class="n">lab2</span><span class="p">:</span> <span class="n">euclidean</span><span class="p">(</span><span class="n">lab1</span><span class="p">,</span> <span class="n">lab2</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">metric_l</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;cmc&quot;</span><span class="p">,</span> <span class="s2">&quot;decmc&quot;</span><span class="p">):</span>
            <span class="n">distance_fn</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">lab1</span><span class="p">,</span> <span class="n">lab2</span><span class="p">:</span> <span class="n">delta_e_cmc</span><span class="p">(</span><span class="n">lab1</span><span class="p">,</span> <span class="n">lab2</span><span class="p">,</span> <span class="n">l</span><span class="o">=</span><span class="n">cmc_l</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">cmc_c</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Unknown metric. Use &#39;euclidean&#39;/&#39;de76&#39;/&#39;de94&#39;/&#39;de2000&#39;/&#39;cmc&#39;.&quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">rec</span> <span class="ow">in</span> <span class="n">candidates</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">d</span> <span class="o">=</span> <span class="n">distance_fn</span><span class="p">(</span><span class="n">target_lab</span><span class="p">,</span> <span class="n">rec</span><span class="o">.</span><span class="n">lab</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">d</span> <span class="o">&lt;</span> <span class="n">best_d</span> <span class="ow">or</span> <span class="p">(</span><span class="n">d</span> <span class="o">==</span> <span class="n">best_d</span> <span class="ow">and</span> <span class="n">best_rec</span> <span class="ow">and</span> <span class="n">_should_prefer_source</span><span class="p">(</span><span class="n">rec</span><span class="o">.</span><span class="n">source</span><span class="p">,</span> <span class="n">best_rec</span><span class="o">.</span><span class="n">source</span><span class="p">)):</span>
                    <span class="n">best_rec</span><span class="p">,</span> <span class="n">best_d</span> <span class="o">=</span> <span class="n">rec</span><span class="p">,</span> <span class="n">d</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="c1"># Skip filaments with invalid colors</span>
                <span class="k">continue</span>
        
        <span class="k">if</span> <span class="n">best_rec</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No valid filaments found&quot;</span><span class="p">)</span>
            
        <span class="k">return</span> <span class="n">best_rec</span><span class="p">,</span> <span class="n">best_d</span></div>


<div class="viewcode-block" id="FilamentPalette.nearest_filaments">
<a class="viewcode-back" href="../../api/color_tools.palette.html#color_tools.palette.FilamentPalette.nearest_filaments">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">nearest_filaments</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">target_rgb</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span>
        <span class="n">metric</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;de2000&quot;</span><span class="p">,</span>
        <span class="n">count</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">maker</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">type_name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">finish</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">cmc_l</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">ColorConstants</span><span class="o">.</span><span class="n">CMC_L_DEFAULT</span><span class="p">,</span>
        <span class="n">cmc_c</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">ColorConstants</span><span class="o">.</span><span class="n">CMC_C_DEFAULT</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">FilamentRecord</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Find nearest N filaments by color similarity, with optional filters.</span>
<span class="sd">        </span>
<span class="sd">        Similar to nearest_filament but returns multiple results sorted by distance.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            target_rgb: Target RGB color tuple.</span>
<span class="sd">            metric: Distance metric - &#39;euclidean&#39;, &#39;de76&#39;, &#39;de94&#39;, &#39;de2000&#39;, &#39;cmc&#39;.</span>
<span class="sd">            count: Number of results to return (default: 5, max: 50)</span>
<span class="sd">            maker: Optional maker name or list of names to filter by. Use &quot;*&quot; to ignore filter.</span>
<span class="sd">            type_name: Optional filament type or list of types to filter by. Use &quot;*&quot; to ignore filter.</span>
<span class="sd">            finish: Optional filament finish or list of finishes to filter by. Use &quot;*&quot; to ignore filter.</span>
<span class="sd">            cmc_l, cmc_c: Parameters for CMC metric.</span>
<span class="sd">        </span>
<span class="sd">        Returns:</span>
<span class="sd">            List of (filament_record, distance) tuples sorted by distance (closest first).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Limit count to reasonable maximum</span>
        <span class="n">count</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">count</span><span class="p">,</span> <span class="mi">50</span><span class="p">)</span>
        <span class="n">count</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">count</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        
        <span class="n">target_lab</span> <span class="o">=</span> <span class="n">rgb_to_lab</span><span class="p">(</span><span class="n">target_rgb</span><span class="p">)</span>
        
        <span class="c1"># Handle &quot;*&quot; wildcard filters (ignore filter if &quot;*&quot; is passed)</span>
        <span class="n">maker_filter</span> <span class="o">=</span> <span class="kc">None</span> <span class="k">if</span> <span class="n">maker</span> <span class="o">==</span> <span class="s2">&quot;*&quot;</span> <span class="k">else</span> <span class="n">maker</span>
        <span class="n">type_filter</span> <span class="o">=</span> <span class="kc">None</span> <span class="k">if</span> <span class="n">type_name</span> <span class="o">==</span> <span class="s2">&quot;*&quot;</span> <span class="k">else</span> <span class="n">type_name</span>
        <span class="n">finish_filter</span> <span class="o">=</span> <span class="kc">None</span> <span class="k">if</span> <span class="n">finish</span> <span class="o">==</span> <span class="s2">&quot;*&quot;</span> <span class="k">else</span> <span class="n">finish</span>
        
        <span class="c1"># Apply filters by calling our powerful filter() method first!</span>
        <span class="n">candidates</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">maker</span><span class="o">=</span><span class="n">maker_filter</span><span class="p">,</span> <span class="n">type_name</span><span class="o">=</span><span class="n">type_filter</span><span class="p">,</span> <span class="n">finish</span><span class="o">=</span><span class="n">finish_filter</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">candidates</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No filaments match the specified filters&quot;</span><span class="p">)</span>

        <span class="c1"># Choose distance function</span>
        <span class="n">metric_l</span> <span class="o">=</span> <span class="n">metric</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">metric_l</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;de2000&quot;</span><span class="p">,</span> <span class="s2">&quot;ciede2000&quot;</span><span class="p">):</span>
            <span class="n">distance_fn</span> <span class="o">=</span> <span class="n">delta_e_2000</span>
        <span class="k">elif</span> <span class="n">metric_l</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;de94&quot;</span><span class="p">,</span> <span class="s2">&quot;cie94&quot;</span><span class="p">):</span>
            <span class="n">distance_fn</span> <span class="o">=</span> <span class="n">delta_e_94</span>
        <span class="k">elif</span> <span class="n">metric_l</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;de76&quot;</span><span class="p">,</span> <span class="s2">&quot;cie76&quot;</span><span class="p">):</span>
            <span class="n">distance_fn</span> <span class="o">=</span> <span class="n">delta_e_76</span>
        <span class="k">elif</span> <span class="n">metric_l</span> <span class="o">==</span> <span class="s2">&quot;euclidean&quot;</span><span class="p">:</span>
            <span class="n">distance_fn</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">lab1</span><span class="p">,</span> <span class="n">lab2</span><span class="p">:</span> <span class="n">euclidean</span><span class="p">(</span><span class="n">lab1</span><span class="p">,</span> <span class="n">lab2</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">metric_l</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;cmc&quot;</span><span class="p">,</span> <span class="s2">&quot;decmc&quot;</span><span class="p">):</span>
            <span class="n">distance_fn</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">lab1</span><span class="p">,</span> <span class="n">lab2</span><span class="p">:</span> <span class="n">delta_e_cmc</span><span class="p">(</span><span class="n">lab1</span><span class="p">,</span> <span class="n">lab2</span><span class="p">,</span> <span class="n">l</span><span class="o">=</span><span class="n">cmc_l</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">cmc_c</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Unknown metric. Use &#39;euclidean&#39;/&#39;de76&#39;/&#39;de94&#39;/&#39;de2000&#39;/&#39;cmc&#39;.&quot;</span><span class="p">)</span>

        <span class="n">results</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">FilamentRecord</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">rec</span> <span class="ow">in</span> <span class="n">candidates</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">d</span> <span class="o">=</span> <span class="n">distance_fn</span><span class="p">(</span><span class="n">target_lab</span><span class="p">,</span> <span class="n">rec</span><span class="o">.</span><span class="n">lab</span><span class="p">)</span>
                <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">rec</span><span class="p">,</span> <span class="n">d</span><span class="p">))</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="c1"># Skip filaments with invalid colors</span>
                <span class="k">continue</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">results</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No valid filaments found&quot;</span><span class="p">)</span>
        
        <span class="n">results</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">results</span><span class="p">[:</span><span class="n">count</span><span class="p">]</span></div>


    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">makers</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get sorted list of all makers.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_by_maker</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">types</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get sorted list of all types.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_by_type</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">finishes</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get sorted list of all finishes.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_by_finish</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

<div class="viewcode-block" id="FilamentPalette.get_override_info">
<a class="viewcode-back" href="../../api/color_tools.palette.html#color_tools.palette.FilamentPalette.get_override_info">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_override_info</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get information about user overrides in this filament palette.</span>
<span class="sd">        </span>
<span class="sd">        Returns:</span>
<span class="sd">            Dictionary with override information structure:</span>
<span class="sd">            </span>
<span class="sd">            .. code-block:: python</span>
<span class="sd">            </span>
<span class="sd">                {</span>
<span class="sd">                    &quot;filaments&quot;: {</span>
<span class="sd">                        &quot;rgb&quot;: {&quot;(r,g,b)&quot;: {&quot;core&quot;: [sources], &quot;user&quot;: [sources]}}</span>
<span class="sd">                    },</span>
<span class="sd">                    &quot;synonyms&quot;: {</span>
<span class="sd">                        &quot;maker_name&quot;: {</span>
<span class="sd">                            &quot;type&quot;: &quot;replaced|extended&quot;,</span>
<span class="sd">                            &quot;old&quot;: [core_synonyms],</span>
<span class="sd">                            &quot;new&quot;: [user_synonyms]</span>
<span class="sd">                        }</span>
<span class="sd">                    }</span>
<span class="sd">                }</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Any</span>
        
        <span class="n">overrides</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;filaments&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;rgb&quot;</span><span class="p">:</span> <span class="p">{}},</span>
            <span class="s2">&quot;synonyms&quot;</span><span class="p">:</span> <span class="p">{}</span>
        <span class="p">}</span>
        
        <span class="c1"># Check for filament RGB overrides</span>
        <span class="n">rgb_groups</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span> <span class="n">List</span><span class="p">[</span><span class="n">FilamentRecord</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">record</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">records</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">record</span><span class="o">.</span><span class="n">rgb</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">rgb_groups</span><span class="p">:</span>
                <span class="n">rgb_groups</span><span class="p">[</span><span class="n">record</span><span class="o">.</span><span class="n">rgb</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">rgb_groups</span><span class="p">[</span><span class="n">record</span><span class="o">.</span><span class="n">rgb</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">record</span><span class="p">)</span>
        
        <span class="k">for</span> <span class="n">rgb</span><span class="p">,</span> <span class="n">records</span> <span class="ow">in</span> <span class="n">rgb_groups</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">core_records</span> <span class="o">=</span> <span class="p">[</span><span class="n">r</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">records</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">r</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;user-&#39;</span><span class="p">)]</span>
            <span class="n">user_records</span> <span class="o">=</span> <span class="p">[</span><span class="n">r</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">records</span> <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;user-&#39;</span><span class="p">)]</span>
            <span class="k">if</span> <span class="n">core_records</span> <span class="ow">and</span> <span class="n">user_records</span><span class="p">:</span>
                <span class="n">overrides</span><span class="p">[</span><span class="s2">&quot;filaments&quot;</span><span class="p">][</span><span class="s2">&quot;rgb&quot;</span><span class="p">][</span><span class="nb">str</span><span class="p">(</span><span class="n">rgb</span><span class="p">)]</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s2">&quot;core&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">r</span><span class="o">.</span><span class="n">source</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">core_records</span><span class="p">],</span>
                    <span class="s2">&quot;user&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">r</span><span class="o">.</span><span class="n">source</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">user_records</span><span class="p">]</span>
                <span class="p">}</span>
        
        <span class="c1"># Check for synonym overrides</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">maker_synonyms</span><span class="p">:</span>
            <span class="c1"># We need to reconstruct what the core synonyms were vs user synonyms</span>
            <span class="c1"># This is complex since synonyms are already merged, but we can infer from source patterns</span>
            <span class="c1"># For testing purposes, we&#39;ll create a basic detection</span>
            
            <span class="c1"># Load core synonyms to compare</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="kn">from</span><span class="w"> </span><span class="nn">color_tools.palette</span><span class="w"> </span><span class="kn">import</span> <span class="n">load_maker_synonyms</span>
                <span class="n">core_synonyms</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="c1"># Try to load core synonyms from default location</span>
                    <span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
                    <span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>
                    <span class="n">core_file</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span><span class="o">.</span><span class="n">parent</span> <span class="o">/</span> <span class="s2">&quot;data&quot;</span> <span class="o">/</span> <span class="s2">&quot;maker_synonyms.json&quot;</span>
                    <span class="k">if</span> <span class="n">core_file</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">core_file</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                            <span class="n">core_synonyms</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="k">pass</span>
                
                <span class="c1"># Compare current synonyms with core synonyms</span>
                <span class="k">for</span> <span class="n">maker</span><span class="p">,</span> <span class="n">current_synonyms</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">maker_synonyms</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">maker</span> <span class="ow">in</span> <span class="n">core_synonyms</span><span class="p">:</span>
                        <span class="n">core_syns</span> <span class="o">=</span> <span class="n">core_synonyms</span><span class="p">[</span><span class="n">maker</span><span class="p">]</span>
                        <span class="k">if</span> <span class="nb">set</span><span class="p">(</span><span class="n">current_synonyms</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">set</span><span class="p">(</span><span class="n">core_syns</span><span class="p">):</span>
                            <span class="n">overrides</span><span class="p">[</span><span class="s2">&quot;synonyms&quot;</span><span class="p">][</span><span class="n">maker</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                                <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;replaced&quot;</span><span class="p">,</span>
                                <span class="s2">&quot;old&quot;</span><span class="p">:</span> <span class="n">core_syns</span><span class="p">,</span>
                                <span class="s2">&quot;new&quot;</span><span class="p">:</span> <span class="n">current_synonyms</span>
                            <span class="p">}</span>
                    <span class="c1"># If maker not in core synonyms, it&#39;s an addition (not override)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="c1"># If we can&#39;t load core synonyms, skip synonym override detection</span>
                <span class="k">pass</span>
        
        <span class="k">return</span> <span class="n">overrides</span></div>
</div>


</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024, David Terracino.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>